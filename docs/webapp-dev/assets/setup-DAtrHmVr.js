import{bR as ut,t as h,bS as mt,bT as pt,bU as ft,bV as gt,bW as St,bX as Et,bY as Rt,bZ as _t,b_ as It,by as A,$ as p,b$ as we,az as k,c0 as Mt,am as ne,c1 as be,c2 as b,c3 as Tt,c4 as yt,c5 as Pt,c6 as Xe,af as Ie,c7 as Ct,c8 as wt,r as Oe,bJ as bt,S as B,b as m,c as Ot,C as S,bv as q,M as re,R as w,c9 as At,bB as Le,a7 as j,ca as Nt,cb as Me,cc as kt,cd as le,ce as Ze,a_ as vt,aX as Dt,cf as Te,cg as ye,ch as Lt,ci as Gt,cj as et,ck as Bt,cl as Ut,cm as Ge,h as Ht,U as Ft,T as xt,bK as Wt,cn as Be,bL as $t,Q as Ae,b1 as Vt,aV as Kt,aY as Ne,co as Ue,cp as He,cq as f,ai as ce,N as oe,cr as J,cs as X,ct as de,b2 as Yt,b5 as Fe,bu as qt,Z as _,ba as Jt,Y as K,k as ke,X as tt,ag as M,W as st,cu as jt,cv as zt,cw as xe,cx as Qt,bq as We,aq as F,O as Xt,cy as Zt,cz as es,cA as ts,cB as ss,bN as is,bs as rs,cC as $e,cD as Ve,a3 as Z,cE as os,w as as,cF as T}from"./confirm-BfAxGSe4.js";import{u as L}from"./HorizontalSelector-DcZDHc5A.js";import{L as ns}from"./prompt-DHQQ_qzX.js";function Ke(s){return s instanceof ut?new Error(`${h.invalidPieceName}: ${s.data}`):s instanceof mt?new Error(`${h.invalidTurn}: ${s.data}`):s instanceof pt?new Error(`${h.invalidMove}: ${s.data}`):s instanceof ft?new Error(`${h.invalidMoveNumber}: ${s.data}`):s instanceof gt?new Error(`${h.invalidDestination}: ${s.data}`):s instanceof St?new Error(`${h.pieceNotExists}: ${s.data}`):s instanceof Et?new Error(`${h.invalidLine}: ${s.data}`):s instanceof Rt?new Error(`${h.invalidBoard}: ${s.data}`):s instanceof _t?new Error(`${h.invalidHandPiece}: ${s.data}`):s instanceof It?new Error(`${h.invalidUSI}: ${s.data}`):s}let te,ae;function cs(){return(!ae||ae.state==="closed")&&(ae=new AudioContext),ae}function it(s){if(s.volume<=0||te)return;const e=cs(),t=e.createOscillator(),i=e.createGain();t.connect(i),i.connect(e.destination),t.type="sine",t.frequency.value=s.frequency,i.gain.value=s.volume*.005,t.onended=()=>{i.disconnect(e.destination),t.disconnect(i)},t.start(e.currentTime),s?.time&&t.stop(e.currentTime+s.time),s?.time||(te=t)}function hs(s){it({frequency:s.frequency,time:.1,volume:s.volume})}function ls(s){it({frequency:s.frequency,volume:s.volume})}function Ye(){te&&(te.stop(),te=void 0)}let ue;function me(s){if(s<=0)return;const e=Date.now();if(ue&&e<ue+200)return;const t=new Audio("sound/piece.mp3");t.volume=s*.01,t.play(),ue=e}function ds(s){return s>=1500?"先手勝勢":s>=600?"先手優勢":s>=400?"先手有利":s>=200?"先手有望":s>-200?"互角":s>-400?"後手有望":s>-600?"後手有利":s>-1500?"後手優勢":"後手勝勢"}function qe(s,e){return 100/(1+Math.exp(-s/e))}const ve=1e4;function us(s,e){const t=[],i=s.clone();for(const r of e){const o=i.createMoveByUSI(r);if(!o||!i.doMove(o))break;t.push(o)}return t}function ms(s){const e=Math.floor(s/60),t=s%60;return String(e).padStart(2,"0")+":"+String(t).padStart(2,"0")}var C=(s=>(s[s.PLAYER=0]="PLAYER",s[s.OPPONENT=1]="OPPONENT",s[s.RESEARCHER=2]="RESEARCHER",s[s.RESEARCHER_2=3]="RESEARCHER_2",s[s.RESEARCHER_3=4]="RESEARCHER_3",s[s.RESEARCHER_4=5]="RESEARCHER_4",s))(C||{});function ps(s){const e=/^\*詰み=(先手勝ち|後手勝ち)(?::([0-9]+)手)?/.exec(s);if(e)return Number(e[2]||ve)*(e[1]==="先手勝ち"?1:-1)}function fs(s){const e=/^#詰み=(先手勝ち|後手勝ち)(?::([0-9]+)手)?/.exec(s);if(e)return Number(e[2]||ve)*(e[1]==="先手勝ち"?1:-1)}function gs(s){const e=/^\*評価値=([+-]?[.0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Ss(s){const e=/^#評価値=([+-]?[.0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Es(s){const e=/^\* *([+-]?[.0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Rs(s){const e=/^\*対局 .* 評価値 ([+-]?[0-9]+)/.exec(s);return e?Number(e[1]):void 0}function _s(s){const e=/^\*解析 .* 評価値 ([+-]?[0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Is(s){const e=/^\* .* 評価値 ([+-]?[0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Ms(s){const e=/^#(?:形勢|指し手)\[([+-]?[0-9]+)\]/.exec(s);return e?Number(e[1]):void 0}function pe(s){s.forEach(e=>{const t=e.customData||{},i=e.comment.split(`
`);for(const r of i){const o=ps(r);o!==void 0&&(t.playerSearchInfo={...t.playerSearchInfo,mate:o});const a=fs(r);a!==void 0&&(t.researchInfo={...t.researchInfo,mate:a});const c=gs(r)||Es(r)||Rs(r);c!==void 0&&(t.playerSearchInfo={...t.playerSearchInfo,score:c});const d=Ss(r)||_s(r)||Is(r)||Ms(r);d!==void 0&&(t.researchInfo={...t.researchInfo,score:d})}e.customData=t})}function Ts(s,e,t,i){const r=e===0?"*":"#";let o="";if(t.mate){const a=t.mate>=0?"先手勝ち":"後手勝ち";o+=`${r}詰み=${a}`,Math.abs(t.mate)!==ve&&(o+=`:${Math.abs(t.mate)}手`),o+=`
`}return t.score!==void 0&&(o+=ds(t.score)+`
`,o+=`${r}評価値=${t.score}
`),t.pv&&t.pv.length!==0&&(o+=`${r}読み筋=${kt(s,t.pv)}
`),t.depth&&(o+=`${r}深さ=${t.depth}
`),t.nodes&&(o+=`${r}ノード数=${t.nodes}
`),o&&i?.engineName&&(o+=`${r}エンジン=${i.engineName}
`),o}function rt(s){let t=`* ${s.mate!==void 0?s.mate>0?3e4:-3e4:s.score!==void 0?s.score:0}`;for(const i of s.pv||[])t+=" "+Me(i);return t}function ys(s){return rt(s)+(s.nodes!==void 0?` #${s.nodes}`:"")}function Ps(s,e){let t=`*${s===0?"対局":"解析"}`;if(e.depth!==void 0&&(t+=` 深さ ${e.depth}`),e.nodes!==void 0&&(t+=` ノード数 ${e.nodes}`),e.score!==void 0?t+=` 評価値 ${e.score}`:e.mate!==void 0&&(t+=` 評価値 ${e.mate>0?3e4:-3e4}`),e.pv?.length){t+=" 読み筋";for(const i of e.pv)t+=" "+(i.color===S.BLACK?"▲":"△")+Nt(i)}return t}function Cs(s,e){const t=e.indexOf(" ",e.indexOf(" ")+1)+1,i=[],r=s.clone();for(let o=t;o<e.length;o+=8){const a=e.substring(o,o+7),c=Ze(r,a);if(c instanceof Error||!r.doMove(c,{ignoreValidation:!1}))break;i.push(c)}return i}function ws(s,e){const t=[];for(const i of e.split(`
`)){let r;if(/^[#*]読み筋=/.test(i))r=le(s,i.substring(5));else if(/^\*.* 読み筋 /.test(i)){const o=i.substring(i.indexOf(" 読み筋 ")+5),a=s.color===S.BLACK?"▲":"△";r=le(s,o.substring(o.indexOf(a)))}else if(/^#(?:指し手|形勢)\[/.test(i)){const o=i.substring(i.indexOf("]")+1),a=s.color===S.BLACK?"▲":"△";r=le(s,o.substring(o.indexOf(a)))}else/^\* -?[0-9]+ /.test(i)&&(r=Cs(s,i));r?.length&&t.push(r)}return t}function bs(s){return s.timeSeconds+"+"+s.byoyomi+"+"+s.increment}function Os(s){return ms(s.timeSeconds)+"+"+String(s.byoyomi).padStart(2,"0")}class ot{constructor(e=new A){this._record=e,this.resetPositionCounts(),this.bindRecordHandlers()}_recordFilePath;_unsaved=!1;_sourceURL;_positionCounts=new Map;changePositionHandler=null;updateTreeHandler=null;updateCommentHandler=null;updateBookmarkHandler=null;updateCustomDataHandler=null;backupHandler=null;get record(){return this._record}get recordFilePath(){return this._recordFilePath}get unsaved(){return this._unsaved}get sourceURL(){return this._sourceURL}get positionCounts(){return this._positionCounts}updateRecordFilePath(e){this._unsaved=!1,e!==this._recordFilePath&&(this._recordFilePath=e,e&&p.addRecordFileHistory(e))}async saveBackup(){if(!this.unsaved)return;const e=this.onBackup(),t=we(this.record,e||{});await p.saveRecordFileBackup(t)}saveBackupOnBackground(){this.saveBackup().catch(e=>{p.log(k.ERROR,`RecordManager#saveBackupOnBackground: failed to save backup: ${e}`)})}clearRecord(e){this.saveBackupOnBackground(),this._record.clear(e),this._unsaved=!1,this._recordFilePath=void 0,this._sourceURL=void 0,this.onChangePosition(),this.onUpdateTree()}replaceRecord(e,t){this.saveBackupOnBackground(),this._record=e,this.resetPositionCounts(),this.bindRecordHandlers(),this.updateRecordFilePath(t?.path),this._unsaved=!t?.markAsSaved,this._sourceURL=void 0,pe(this._record),this.onChangePosition(),this.onUpdateTree()}reset(){this.clearRecord()}resetByInitialPositionType(e){this.resetBySFEN(Mt(e))}resetBySFEN(e){const t=new ne;return t.resetBySFEN(e)?(this.clearRecord(t),!0):!1}resetByUSEN(e,t,i){const r=A.newByUSEN(e,t,i);if(r instanceof Error)return r;this.replaceRecord(r,{markAsSaved:!0})}resetByCurrentPosition(){this.clearRecord(this._record.position)}parseRecordData(e,t){let i;switch(t||be(e)){case b.SFEN:{const r=ne.newBySFEN(e);i=r?new A(r):new Error(h.failedToParseSFEN);break}case b.USI:i=A.newByUSI(e);break;case b.KIF:i=Xe(e);break;case b.KI2:i=Pt(e);break;case b.CSA:i=yt(e);break;case b.JKF:i=Tt(e);break;case b.USEN:i=A.newByUSEN(e);break;default:i=new Error(h.failedToDetectRecordFormat);break}return i instanceof Error?Ke(i):i}importRecord(e,t){const i=this.parseRecordData(e,t?.type);if(i instanceof Error)return i;switch(t?.mode||"standard"){case"standard":this.replaceRecord(i,t);break;case"mergeIntoRoot":return this.mergeRecord(i);case"mergeIntoCurrent":return this.mergeRecordIntoCurrent(i)}}importRecordFromBuffer(e,t,i){const r=Ie(t);if(!r)return new Error(`${h.unknownFileExtension}: ${t}`);const o=Ct(e,r,i);if(o instanceof Error)return Ke(o);this.replaceRecord(o,{path:t,markAsSaved:!0})}async importRecordFromRemoteURL(e){const t=!!e;if(e=e||this._sourceURL,!e)throw new Error("RecordManager#importRecordFromRemoteURL: source URL is not set");const i=await p.loadRemoteTextFile(e),r=this.parseRecordData(i);if(r instanceof Error)throw r;if(t){this.replaceRecord(r),this._sourceURL=e;return}const o=this.mergeRecord(r);if(o)throw o}exportRecordAsBuffer(e,t){const i=Ie(e);if(!i)return new Error(`${h.unknownFileExtension}: ${e}`);const r=wt(this._record,i,t);return this.updateRecordFilePath(e),r}applyPosition(e){this._record.clear(e),this._unsaved=!0,this._recordFilePath=void 0,this.onChangePosition()}swapNextTurn(){const e=this.record.position.clone();e.setColor(Oe(e.color)),this.applyPosition(e)}changePosition(e){const t=this.record.position.clone();t.edit(e),this.applyPosition(t)}changePieceSet(e){const t=this.record.position.clone(),i=bt(this.record.position),r={king:e.king-i.king,rook:e.rook-(i.rook+i.dragon),bishop:e.bishop-(i.bishop+i.horse),gold:e.gold-i.gold,silver:e.silver-(i.silver+i.promSilver),knight:e.knight-(i.knight+i.promKnight),lance:e.lance-(i.lance+i.promLance),pawn:e.pawn-(i.pawn+i.promPawn)};Object.entries(r).filter(([,o])=>o<0).forEach(([o,a])=>{const c=o;for(let d=0;d>a;d--){const u=B.all.find(g=>t.board.at(g)?.unpromoted().type===c);u?t.board.remove(u):c!==m.KING&&(t.blackHand.count(c)>t.whiteHand.count(c)?t.blackHand.reduce(c,1):t.whiteHand.reduce(c,1))}}),Object.entries(r).filter(([,o])=>o>0).forEach(([o,a])=>{const c=o;for(let d=0;d<a;d++){const u=B.all.find(g=>!t.board.at(g));u?t.board.set(u,new Ot(S.BLACK,c)):c!==m.KING&&(t.blackHand.count(c)<=t.whiteHand.count(c)?t.blackHand.add(c,1):t.whiteHand.add(c,1))}}),this.applyPosition(t)}goForward(){this._record.goForward()}goBack(){this._record.goBack()}changePly(e){this._record.goto(e)}changeBranch(e){return this._record.switchBranchByIndex(e)}changeNode(e){return this._record.gotoNode(e)}swapWithNextBranch(){return this._record.swapWithNextBranch()?(this._unsaved=!0,!0):!1}swapWithPreviousBranch(){return this._record.swapWithPreviousBranch()?(this._unsaved=!0,!0):!1}resetAllBranchSelection(){this._record.resetAllBranchSelection()}removeCurrentMove(){return this._record.removeCurrentMove()?(this._unsaved=!0,this.onUpdateTree(),!0):!1}removeNextMove(){return this._record.removeNextMove()?(this._unsaved=!0,this.onUpdateTree(),!0):!1}jumpToBookmark(e){return this._record.jumpToBookmark(e)}updateComment(e){this._record.current.comment=e,this._unsaved=!0,this.onUpdateComment()}updateBookmark(e){this._record.current.bookmark=e,this._unsaved=!0,this.onUpdateBookmark()}appendComment(e,t){if(!e)return;const i=this._record.current.comment,r=this.record.current.comment?`
`:"";switch(t){case q.NONE:break;case q.INSERT:this._record.current.comment=e+r+i;break;case q.APPEND:this._record.current.comment=i+r+e;break;case q.OVERWRITE:this._record.current.comment=e;break}this._unsaved=!0,this.onUpdateComment()}appendSearchComment(e,t,i,r,o){let a;switch(t){case re.SHOGIHOME:a=Ts(this.record.position,e,i,o);break;case re.FLOODGATE:a=rt(i);break;case re.CSA3:a=ys(i);break;case re.SHOGIGUI:a=Ps(e,i);break}o?.header&&(a=o.header+`
`+a),this.appendComment(a,r),this._unsaved=!0}get inCommentPVs(){return ws(this.record.position,this.record.current.comment)}setGameStartMetadata(e){e.gameTitle&&this._record.metadata.setStandardMetadata(w.TITLE,e.gameTitle),e.blackName&&this._record.metadata.setStandardMetadata(w.BLACK_NAME,e.blackName),e.whiteName&&this._record.metadata.setStandardMetadata(w.WHITE_NAME,e.whiteName),this._record.metadata.setStandardMetadata(w.DATE,At()),this._record.metadata.setStandardMetadata(w.START_DATETIME,Le());const i=e.blackTimeLimit.increment||e.whiteTimeLimit.increment?bs:Os,r=i(e.blackTimeLimit),o=i(e.whiteTimeLimit);r===o?this._record.metadata.setStandardMetadata(w.TIME_LIMIT,r):(this._record.metadata.setStandardMetadata(w.BLACK_TIME_LIMIT,r),this._record.metadata.setStandardMetadata(w.WHITE_TIME_LIMIT,o)),this._unsaved=!0}setGameEndMetadata(){this._record.metadata.setStandardMetadata(w.END_DATETIME,Le()),this._unsaved=!0}updateSearchInfo(e,t){const i=this.record.current.customData||{};switch(e){case 0:i.playerSearchInfo=t;break;case 1:i.opponentSearchInfo=t;break;case 2:(t.depth||0)>=(i.researchInfo?.depth||0)&&(i.researchInfo=t);break;case 3:(t.depth||0)>=(i.researchInfo2?.depth||0)&&(i.researchInfo2=t);break;case 4:(t.depth||0)>=(i.researchInfo3?.depth||0)&&(i.researchInfo3=t);break;case 5:(t.depth||0)>=(i.researchInfo4?.depth||0)&&(i.researchInfo4=t);break}this._record.current.customData=i,this.onUpdateCustomData()}appendMove(e){return this._record.append(e.move,e.moveOption)?(e.elapsedMs!==void 0&&this._record.current.setElapsedMs(e.elapsedMs),this._unsaved=!0,!0):!1}appendMovesSilently(e,t){this.unbindChangePositionHandler();try{let i=0;const r=this._record.current.ply;for(const o of e){if(!this._record.append(o,t))break;i++}return this._record.goto(r),this._unsaved=!0,this.onUpdateTree(),i}finally{this.bindRecordHandlers()}}mergeRecord(e){if(this._record.initialPosition.sfen!==e.initialPosition.sfen)return new Error(h.failedToMergeRecordWithDifferentInitialPosition);this._record.merge(e),this._unsaved=!0,pe(this._record),this.onUpdateTree()}mergeRecordIntoCurrent(e){if(this._record.position.color!==e.initialPosition.color)return new Error(h.failedToMergeRecordWithDifferentTurn);const{successCount:t,skipCount:i}=this._record.mergeIntoCurrentPosition(e);if(this._unsaved=!0,pe(this._record),this.onUpdateTree(),i>0)return new Error(h.skippedMovesInMerge(i,t+i))}updateStandardMetadata(e){this._record.metadata.setStandardMetadata(e.key,e.value),this._unsaved=!0}on(e,t){switch(e){case"changePosition":this.changePositionHandler=t;break;case"updateTree":this.updateTreeHandler=t;break;case"updateComment":this.updateCommentHandler=t;break;case"updateBookmark":this.updateBookmarkHandler=t;break;case"updateCustomData":this.updateCustomDataHandler=t;break;case"backup":this.backupHandler=t;break}return this}onChangePosition(){this.changePositionHandler&&this.changePositionHandler()}onUpdateTree(){this.updateTreeHandler&&this.updateTreeHandler()}onUpdateComment(){this.updateCommentHandler&&this.updateCommentHandler()}onUpdateBookmark(){this.updateBookmarkHandler&&this.updateBookmarkHandler()}onUpdateCustomData(){this.updateCustomDataHandler&&this.updateCustomDataHandler()}onBackup(){return this.backupHandler?this.backupHandler():null}resetPositionCounts(){this._positionCounts.clear(),this._record.forEach(e=>{this.addPositionCount(e)})}isPositionCountTarget(e){return e.ply===0||e.move instanceof j}addPositionCount(e){if(!this.isPositionCountTarget(e))return;const t=this._positionCounts.get(e.sfen)||0;this._positionCounts.set(e.sfen,t+1)}reducePositionCount(e){if(!this.isPositionCountTarget(e))return;const t=this._positionCounts.get(e.sfen)||0;t>1?this._positionCounts.set(e.sfen,t-1):this._positionCounts.delete(e.sfen)}bindRecordHandlers(){this._record.on("changePosition",this.onChangePosition.bind(this)),this._record.on("clear",this.resetPositionCounts.bind(this)),this._record.on("addNode",e=>{this.addPositionCount(e)}),this._record.on("removeNode",e=>{this.reducePositionCount(e)})}unbindChangePositionHandler(){this._record.on("changePosition",()=>{})}}class As{searchHandler;isEngine(){return!1}async readyNewGame(){}async startSearch(e,t,i,r){this.searchHandler=r}async startPonder(){}async startMateSearch(){}async stop(){}async gameover(){}async close(){this.searchHandler=void 0}doMove(e){const t=this.searchHandler;this.searchHandler=void 0,t?.onMove(e)}resign(){const e=this.searchHandler;this.searchHandler=void 0,e?.onResign()}win(){const e=this.searchHandler;this.searchHandler=void 0,e?.onWin()}}const Pe=new As;let Y=()=>{},ee=()=>{};function Ns(s){Y=s}function ks(s){ee=s}class ie{constructor(e,t,i){this.engine=e,this.launchOptions=t,this.onSearchInfo=i}_sessionID=0;usi;position;searchHandler;mateHandler;ponder;ponderMove;info;usiInfoTimeout;customMultiPV;bookSessionID;get name(){return this.engine.name}get sessionID(){return this._sessionID}async launch(){try{this.engine.extraBook?.enabled&&this.engine.extraBook.filePath&&(this.bookSessionID=await p.openBookAsNewSession(this.engine.extraBook.filePath,{forceOnTheFly:this.engine.extraBook.onTheFly})),this._sessionID=await p.usiLaunch(this.engine,this.launchOptions),$[this.sessionID]=this}catch(e){throw this.bookSessionID&&await p.closeBookSession(this.bookSessionID),e}}isEngine(){return!0}async readyNewGame(){await p.usiReady(this.sessionID)}async startSearch(e,t,i,r){this.clearHandlers(),this.searchHandler=r,this.usi=t,this.position=e.clone(),!await this.searchBook()&&(this.ponderMove&&this.ponder===this.usi?p.usiPonderHit(this.sessionID,i):(this.info=void 0,await p.usiGo(this.sessionID,this.usi,i),Y(this.sessionID,this.position)),this.ponderMove=void 0,this.ponder=void 0)}async startPonder(e,t,i){if(!vt(this.engine)||this.ponderMove)return;const r=t;if(!this.ponder||!this.ponder.startsWith(r))return;const o=e.createMoveByUSI(this.ponder.slice(r.length+1));!o||!e.isValidMove(o)||(this.clearHandlers(),this.usi=this.ponder,this.position=e.clone(),this.stochasticPonder||this.position.doMove(o),this.info=void 0,this.ponderMove=o,await p.usiGoPonder(this.sessionID,this.ponder,i),Y(this.sessionID,this.position))}async startMateSearch(e,t,i,r){this.clearHandlers(),this.usi=t,this.info=void 0,this.position=e.clone(),this.mateHandler=r,await p.usiGoMate(this.sessionID,this.usi,i),Y(this.sessionID,this.position)}async startResearch(e,t){this.clearHandlers(),this.usi=t,this.info=void 0,this.position=e.clone(),!await this.searchBook()&&(await p.usiGoInfinite(this.sessionID,t),Y(this.sessionID,this.position))}async searchBook(){if(!this.bookSessionID||!this.position)return!1;try{const e=await p.searchBookMoves(this.bookSessionID,this.position.sfen);if(e.length===0)return!1;if(this.ponderMove&&(await p.usiStop(this.sessionID),this.ponderMove=void 0,this.ponder=void 0),Y(this.sessionID,this.position),ee&&this.usi)for(let i=0;i<e.length;i++){const r=e[i];if(this.position.createMoveByUSI(r.usi)){const a={multipv:i+1,depth:r.depth,scoreCP:r.score,nodes:r.count,currmove:r.usi,pv:r.usi2?[r.usi,r.usi2]:[r.usi]};ee(this.sessionID,this.position,this.name,a)}}const t=this.searchHandler;if(this.clearHandlers(),t){const i=e[0],r=this.position.createMoveByUSI(i.usi);if(!r)return p.log(k.ERROR,`Failed to search book moves: invalid move from book: ${i.usi}`),!1;t.onMove(r)}return!0}catch(e){return p.log(k.ERROR,`Failed to search book moves: ${e}`),!1}}async stop(){await p.usiStop(this.sessionID)}async gameover(e){await p.usiGameover(this.sessionID,e)}async close(){this.clearHandlers(),await p.usiQuit(this.sessionID),delete $[this.sessionID],this.bookSessionID&&await p.closeBookSession(this.bookSessionID)}clearHandlers(){this.searchHandler=void 0,this.mateHandler=void 0}onBestMove(e,t,i){const r=this.searchHandler;if(this.clearHandlers(),!r||!this.position||e!==this.usi)return;if(t==="resign"){r.onResign();return}if(t==="win"){r.onWin();return}const o=this.position.createMoveByUSI(t);if(!o){r.onError("エンジンから不明な指し手を受信しました:"+t),r.onResign();return}const a=e.indexOf(" moves ")>0;if(this.ponder=i&&`${e}${a?"":" moves"} ${t} ${i}`,this.flushUSIInfo(),this.info?.pv&&this.info.pv.length>=1&&this.info.pv[0].equals(o)){const c={...this.info,pv:this.info.pv.slice(1)};r.onMove(o,c)}else r.onMove(o)}onCheckmate(e,t){if(e!==this.usi||!this.position)return;ee(this.sessionID,this.position,this.name,{pv:t});const i=this.mateHandler;if(this.clearHandlers(),!i)return;const r=this.position,o=[];for(const a of t){const c=r.createMoveByUSI(a);if(!c){i.onError("エンジンから不明な指し手を受信しました:"+a);return}if(o.push(c),!r.doMove(c)){i.onError("エンジンから無効な指し手を受信しました:"+a);return}}i.onCheckmate(o)}onCheckmateNotImplemented(){const e=this.mateHandler;this.clearHandlers(),e?.onNotImplemented()}onCheckmateTimeout(e){if(e!==this.usi||!this.position)return;const t=this.mateHandler;this.clearHandlers(),t?.onTimeout()}onNoMate(e){if(e!==this.usi||!this.position)return;const t=this.mateHandler;this.clearHandlers(),t?.onNoMate()}onUSIInfo(e,t){if(e!==this.usi||!this.position||(ee(this.sessionID,this.position,this.name,t,this.ponderMove),t.multipv&&t.multipv!==1))return;const i=this.position.color===S.BLACK?1:-1,r=t.pv&&t.pv.length>=1?t.pv:t.currmove?[t.currmove]:void 0;this.info={usi:e,depth:t.depth??this.info?.depth,nodes:t.nodes??this.info?.nodes,score:(t.scoreCP&&t.scoreCP*i)??this.info?.score,mate:(t.scoreMate&&t.scoreMate*i)??this.info?.mate,pv:(r&&us(this.position,r))??this.info?.pv},!this.ponderMove&&(this.usiInfoTimeout||(this.usiInfoTimeout=window.setTimeout(()=>{this.flushUSIInfo()},500)))}flushUSIInfo(){this.usiInfoTimeout&&(clearTimeout(this.usiInfoTimeout),this.usiInfoTimeout=void 0),this.info&&this.onSearchInfo?.(this.info)}get multiPV(){return this.customMultiPV||Dt(this.engine)}async setMultiPV(e){const t=this.engine.options[Te]||this.engine.options[ye];if(!t||t.type!=="spin")throw new Error("The engine does not support MultiPV option.");if(t.min&&e<t.min||t.max&&e>t.max)throw new Error("The MultiPV value is out of range.");await p.usiSetOption(this.sessionID,t.name,e.toFixed(0)),this.customMultiPV=e}get stochasticPonder(){return Lt(this.engine)}}const $={};function vs(s,e,t,i){$[s]?.onBestMove(e,t,i)}function Ds(s,e,t){$[s]?.onCheckmate(e,t)}function Ls(s){$[s]?.onCheckmateNotImplemented()}function Gs(s,e){$[s]?.onCheckmateTimeout(e)}function Bs(s,e){$[s]?.onNoMate(e)}function Us(s,e,t){$[s]?.onUSIInfo(e,t)}function Hs(s){return!!$[s]}const G={[m.PAWN]:100,[m.LANCE]:300,[m.KNIGHT]:400,[m.SILVER]:500,[m.GOLD]:600,[m.BISHOP]:700,[m.ROOK]:800,[m.KING]:0,[m.PROM_PAWN]:400,[m.PROM_LANCE]:500,[m.PROM_KNIGHT]:500,[m.PROM_SILVER]:600,[m.HORSE]:1200,[m.DRAGON]:1500};class Fs{constructor(e){this.uri=e}timer;isEngine(){return!0}async readyNewGame(){}async startSearch(e,t,i,r){this.timer=setTimeout(()=>{let o=null;if(this.uri===Gt)o=this.searchRandom(e);else{const a=A.newByUSI(t);if(a instanceof A){const c=d=>a.getRepetitionCount(d)>=1;o=this.search(this.uri,e.clone(),2,c)[0]}}o===null?r.onResign():r.onMove(o)},500)}async startPonder(){}async startMateSearch(){}async stop(){clearTimeout(this.timer)}async gameover(){}async close(){clearTimeout(this.timer)}searchRandom(e){const t=Je(e);for(let i=t.length;i>0;i--){const r=Math.floor(Math.random()*i),o=t[r];if(e.isValidMove(o))return o;t[r]=t[i-1]}return null}search(e,t,i,r){const o=Je(t);let a=null,c=-1/0;for(const d of o){let u=new xs(e,t,d).evaluate();t.doMove(d)&&(u-=r&&r(t)?1e3:i>1?this.search(e,t,i-1)[1]:this.see(t,d.to),t.undoMove(d),u+=Math.random()*10,u>c&&(c=u,a=d))}return a?[a,c]:[null,0]}see(e,t){const i=[],r=[e.board.at(t).type];for(const o of e.listAttackers(t)){const a=e.board.at(o);a.color===e.color?i.push(a.type):r.push(a.type)}return i.sort((o,a)=>G[o]-G[a]),r.sort((o,a)=>G[o]-G[a]),this.seeSearch(0,i,0,r,0)}seeSearch(e,t,i,r,o){if(i>=t.length)return 0;let a=e+G[r[o]]+G[et(r[o])];return a<=0?0:(a-=this.seeSearch(-a,r,o+1,t,i),Math.max(a,0))}}function Je(s){const e=[];function t(i,r,o){const a=s.board.at(r);if(a?.color===s.color)return;const c=new j(i,r,!1,s.color,o,a?.type||null);Wt(o)&&(Be(s.color,i.rank)||Be(s.color,r.rank))&&(e.push(c.withPromote()),o!==m.KNIGHT&&o!==m.SILVER)||e.push(c)}for(const i of s.board.listNonEmptySquares()){const r=s.board.at(i);if(r.color!==s.color)continue;const o=Bt(r);for(const a of o)switch(Ut(r,a)){case Ge.SHORT:{const d=i.neighbor(a);d.valid&&t(i,d,r.type);break}case Ge.LONG:for(let d=i.neighbor(a);d.valid&&(t(i,d,r.type),!s.board.at(d));d=d.neighbor(a));break}}for(const i of Ht)if(s.hand(s.color).count(i)){for(const r of B.all)if(!s.board.at(r)){const o=new j(i,r,!1,s.color,i,null);e.push(o)}}return e}class xs{constructor(e,t,i){this.playerURI=e,this.position=t,this.move=i,i.from instanceof B?(this.drop=!1,this.from=t.color===S.BLACK?i.from:i.from.opposite):this.drop=!0,this.to=t.color===S.BLACK?i.to:i.to.opposite,this.whiteHand=this.position.color===S.BLACK?this.position.whiteHand:this.position.blackHand}drop;from;to;whiteHand;isTo(e,t){return this.to.equals(new B(e,t))}at(e,t){let i=e instanceof B?e:new B(e,t);return this.position.color===S.WHITE&&(i=i.opposite),this.position.board.at(i)}evaluate(){let e=0;if(this.move.capturedPieceType){const t=this.move.capturedPieceType;e+=G[t]+G[et(t)]}if(this.move.promote){const t=this.move.pieceType;e+=G[$t(t)]-G[t]}switch(this.move.pieceType){case m.PAWN:this.to.rank===4?e+=this.drop?10:20:!this.drop&&(this.to.file===1||this.to.file===9)?e+=10:!this.drop&&this.isTo(3,6)&&this.at(4,6)?e+=30:!this.drop&&this.isTo(5,6)&&this.at(4,6)?.type===m.BISHOP&&(e+=50);break;case m.SILVER:this.from&&this.to.rank<this.from.rank&&this.to.rank>=7&&this.to.file>=2&&this.to.file<=8&&(e+=20);break;case m.BISHOP:this.drop&&this.to.rank>=4&&(this.to.file+this.to.rank)%2!==0?e-=200:this.to.file===1||this.to.file===9?e-=500:this.drop&&this.to.rank===1?e-=50:this.isTo(4,6)&&!this.at(5,5)&&!this.at(6,4)&&!this.at(7,3)&&(e+=100);break;case m.ROOK:this.to.rank===7&&(e-=20);break}if(this.from&&(this.move.pieceType===m.PAWN||this.move.pieceType===m.SILVER||this.move.pieceType===m.GOLD||this.move.pieceType===m.PROM_PAWN||this.move.pieceType===m.PROM_LANCE||this.move.pieceType===m.PROM_KNIGHT||this.move.pieceType===m.PROM_SILVER)&&(this.to.rank<this.from.rank?e+=this.to.rank-3:this.to.rank>this.from.rank&&(e+=3-this.to.rank)),this.to.rank<=4&&this.drop)switch(this.move.pieceType){case m.PAWN:e+=this.to.rank*3;break;case m.LANCE:case m.KNIGHT:e+=this.to.rank*2;break;case m.SILVER:case m.GOLD:e+=this.to.rank+40-40;break;case m.BISHOP:e-=100;break;case m.ROOK:e+=500;break}switch(this.playerURI){case xt:e+=this.evaluateStaticRook();break;case Ft:e+=this.evaluateRangingRook();break}return e}evaluateStaticRook(){let e=0;switch(this.move.pieceType){case m.PAWN:this.drop?this.isTo(8,7)?e+=200:this.isTo(8,8)&&(e+=50):this.isTo(2,6)||this.isTo(2,5)?e+=50:this.isTo(7,6)?e+=100:(this.isTo(6,6)||!this.drop&&this.to.file===3)&&(e+=20);break;case m.LANCE:case m.KNIGHT:e-=50;break;case m.SILVER:this.from&&this.from.rank>this.to.rank&&(this.isTo(8,8)||this.isTo(7,7)?e+=100:this.isTo(6,8)||this.isTo(6,7)||this.isTo(3,8)||this.isTo(3,7)||this.isTo(3,5)||this.isTo(4,6)?e+=20:(this.isTo(2,7)||this.isTo(2,6))&&(e+=10));break;case m.GOLD:this.drop||(this.isTo(7,8)?e+=80:this.isTo(5,8)?e+=20:this.isTo(6,7)&&this.from&&this.from.file<=6&&(e+=30));break;case m.BISHOP:this.at(this.to)?.type===m.BISHOP&&(e+=200);break;case m.KING:this.to.file===6&&this.from&&this.from.file===5?e+=30:this.to.file===7&&this.from&&this.from.file===6?e+=100:this.to.file<=4&&(e-=1e3);break}return e}evaluateRangingRook(){let e=0;switch(this.move.pieceType){case m.PAWN:this.drop?this.isTo(8,7)?e+=200:this.isTo(8,8)&&(e+=50):this.isTo(7,6)?e+=100:this.isTo(6,6)&&this.whiteHand.count(m.BISHOP)===0?e+=90:this.isTo(6,5)&&this.at(7,8)?(e+=20,this.at(7,5)&&(e+=200)):this.isTo(7,5)?e-=150:this.to.file===1?(e+=40,this.at(1,4)&&(e+=50)):this.to.file===9&&this.at(9,4)&&(e+=50);break;case m.LANCE:case m.KNIGHT:e-=50;break;case m.SILVER:this.from instanceof B&&this.from.rank>this.to.rank&&this.at(7,6)&&(this.isTo(7,8)?e+=40:this.isTo(6,7)?e+=30:this.isTo(5,6)?e+=10:this.isTo(6,5)?e+=this.at(6,6)?.type===m.PAWN?-10:20:(this.isTo(4,5)||this.isTo(3,8))&&(e+=10));break;case m.GOLD:!this.drop&&this.isTo(7,8)&&(e+=20);break;case m.BISHOP:!this.drop&&this.isTo(7,7)&&(e+=70,this.at(8,5)&&(e+=50));break;case m.ROOK:!this.drop&&this.isTo(6,8)&&(e+=80);break;case m.KING:this.to.file>=5?e-=1e3:this.from&&this.from.file>this.to.file&&this.to.file>=2&&(e+=60+5*(4-this.to.file));break}return e}}function se(s){return{async build(e,t){if(e.uri===Ae)return Pe;if(Vt(e.uri))return new Fs(e.uri);if(Kt(e.uri)&&e.usi){const i=new ie(e.usi,s,t);return await i.launch(),i}throw new Error("defaultPlayerBuilder#build: 予期せぬプレイヤーURIです: "+e.uri)}}}var y=(s=>(s.WIN="win",s.LOSE="lose",s.DRAW="draw",s))(y||{});class Ws{usiList=[];maxRepeat=1;index=0;repeat=0;clear(){this.usiList=[],this.maxRepeat=1,this.index=0,this.repeat=0}async reset(e){const t=await p.loadSFENFile(e.filePath);if(e.order==="shuffle")for(let r=t.length-1;r>0;r--){const o=Math.floor(Math.random()*(r+1));[t[r],t[o]]=[t[o],t[r]]}const i=Math.ceil(e.maxGames/(e.swapPlayers?2:1));t.length>i&&(t.length=i);for(let r=0;r<t.length;r++)!t[r].startsWith("sfen ")&&be(t[r])===b.SFEN&&(t[r]=`sfen ${t[r]}`);if(t.length===0)throw new Error("No available positions in the list.");for(let r=0;r<t.length;r++){const o=A.newByUSI(t[r]);if(!(o instanceof A))throw o}this.usiList=t,this.maxRepeat=e.swapPlayers?2:1,this.index=0,this.repeat=0}next(){return this.usiList.length===0?"position startpos":(this.repeat<this.maxRepeat?this.repeat++:(this.index++,this.repeat=1,this.index>=this.usiList.length&&(this.index=0)),this.usiList[this.index])}}function $s(){return{...Ne(),next:()=>null}}async function at(s){const{settings:e,currentPly:t}=s,i=e.sprtEnabled?e.sprt.maxGames:e.repeat,r=new Ws;let o="";if(e.startPosition==="list")await r.reset({filePath:e.startPositionListFile,swapPlayers:e.swapPlayers,order:e.startPositionListOrder,maxGames:i});else if(e.startPosition==="sfen"){o=e.startPositionSFEN,!o.startsWith("position ")&&!o.startsWith("sfen ")&&be(o)===b.SFEN&&(o=`sfen ${o}`);const c=A.newByUSI(o);if(!(c instanceof A))throw c}let a=0;return{...e,next:c=>{if(a>=i)return null;if(a++,e.startPosition==="current")c.record.current.ply!==t&&(c.changePly(t),c.removeNextMove());else if(e.startPosition==="list"){const E=c.importRecord(r.next(),{type:b.USI,markAsSaved:!0});if(E)return E}else if(e.startPosition==="sfen"){const E=c.importRecord(o,{type:b.USI,markAsSaved:!0});if(E)return E}else c.resetByInitialPositionType(e.startPosition);c.record.current.ply!==0&&e.startPosition!=="current"&&c.updateComment(h.beginFromThisPosition);const d=i>=2?`連続対局 ${a}/${i}`:void 0,u=e.swapPlayers&&a%2===0,g=a,P=Math.floor((a-1)/2)+1;return{gameTitle:d,swapPlayers:u,gameIndex:g,pairIndex:P}}}}const je=1.96,Vs=2.58;function Ks(s,e,t){return Math.abs(s-e*t)/Math.sqrt(t*(1-t)*e)}function fe(s){return 400*Math.log10(s/(1-s))}function Ys(s,e,t){return s*Math.sqrt(e*(1-e)/t)}function Ce(s,e){return{player1:{name:s,win:0,winBlack:0,winWhite:0},player2:{name:e,win:0,winBlack:0,winWhite:0},draw:0,invalid:0,total:0}}function qs(s){const e=s.player1.win+s.player2.win,i=Math.max(s.player1.win,s.player2.win)/e,r=Ys(je,i,e),o=fe(i),a=fe(i-r),c=fe(i+r),d=Math.abs(Ks(s.player1.win,e,.5));return{rating:o,ratingLower:a,ratingUpper:c,npIsGreaterThan5:e>10,zValue:d,significance5pc:d>je,significance1pc:d>Vs}}class nt{constructor(e,t,i){this.recordManager=e,this.blackClock=t,this.whiteClock=i}state="idle";coordinator=$s();blackPlayerSettings=Ue();whitePlayerSettings=Ue();blackTimeLimit=He();whiteTimeLimit=He();blackPlayer;whitePlayer;swapped=!1;playerBuilder=se();_results=Ce("","");currentGameConditions;lastEventID=0;onSaveRecord=()=>{};onGameNext=()=>{};onGameResult=()=>{};onClosed=()=>{};onFlipBoard=()=>{};onPieceBeat=()=>{};onBeepShort=()=>{};onBeepUnlimited=()=>{};onStopBeep=()=>{};onError=()=>{};on(e,t){switch(e){case"saveRecord":this.onSaveRecord=t;break;case"gameNext":this.onGameNext=t;break;case"gameResult":this.onGameResult=t;break;case"closed":this.onClosed=t;break;case"flipBoard":this.onFlipBoard=t;break;case"pieceBeat":this.onPieceBeat=t;break;case"beepShort":this.onBeepShort=t;break;case"beepUnlimited":this.onBeepUnlimited=t;break;case"stopBeep":this.onStopBeep=t;break;case"error":this.onError=t;break}return this}get waitingForHumanPlayerMove(){return(this.recordManager.record.position.color===S.BLACK?this.blackPlayerSettings.uri:this.whitePlayerSettings.uri)===Ae}get results(){return this._results}async startLinear(e,t){const i=await at({settings:e,currentPly:this.recordManager.record.current.ply});await this.start(i,t)}async start(e,t){if(this.state!=="idle")throw Error("GameManager#start: 前回の対局が正常に終了できていません。アプリを再起動してください。");this.state="starting",this.coordinator=e,this.blackPlayerSettings=e.black,this.whitePlayerSettings=e.white,this.blackTimeLimit=e.timeLimit,this.whiteTimeLimit=e.whiteTimeLimit||e.timeLimit,this.playerBuilder=t,this._results=Ce(this.blackPlayerSettings.name,this.whitePlayerSettings.name);const i=this.coordinator.next(this.recordManager);if(i===null)throw this.state="idle",new Error("GameManager#start: 対局タスクが空です。");if(i instanceof Error)throw this.state="idle",new Error(`GameManager#start: ${i.message}`);try{this.blackPlayer=await this.playerBuilder.build(this.blackPlayerSettings,r=>this.updateSearchInfo(C.OPPONENT,r)),this.whitePlayer=await this.playerBuilder.build(this.whitePlayerSettings,r=>this.updateSearchInfo(C.OPPONENT,r)),this.swapped=!1,await this.goNextGame(i)}catch(r){try{await this.closePlayers()}catch(o){this.onError(o)}finally{this.state="idle"}throw new Error(`GameManager#start: ${h.failedToStartNewGame}: ${r}`)}}async goNextGame(e){if(this.blackPlayer===void 0||this.whitePlayer===void 0)throw new Error("GameManager#goNextGame: プレイヤーが初期化されていません。");e.swapPlayers!==this.swapped&&this.swapPlayers(),this.currentGameConditions=e,this.recordManager.setGameStartMetadata({gameTitle:e.gameTitle,blackName:this.blackPlayerSettings.name,whiteName:this.whitePlayerSettings.name,blackTimeLimit:this.blackTimeLimit,whiteTimeLimit:this.whiteTimeLimit}),this.blackClock.setup(this.getBlackClockSettings()),this.whiteClock.setup(this.getWhiteClockSettings()),await Promise.all([this.blackPlayer.readyNewGame(),this.whitePlayer.readyNewGame()]),this.state="active",this.onGameNext(),this.adjustBoardOrientation(),setTimeout(()=>this.nextMove())}getBlackClockSettings(){return{timeMs:this.blackTimeLimit.timeSeconds*1e3,byoyomi:this.blackTimeLimit.byoyomi,increment:this.blackTimeLimit.increment,onBeepShort:()=>this.onBeepShort(),onBeepUnlimited:()=>this.onBeepUnlimited(),onStopBeep:()=>this.onStopBeep(),onTimeout:()=>{this.timeout(S.BLACK)}}}getWhiteClockSettings(){return{timeMs:this.whiteTimeLimit.timeSeconds*1e3,byoyomi:this.whiteTimeLimit.byoyomi,increment:this.whiteTimeLimit.increment,onBeepShort:()=>this.onBeepShort(),onBeepUnlimited:()=>this.onBeepUnlimited(),onStopBeep:()=>this.onStopBeep(),onTimeout:()=>{this.timeout(S.WHITE)}}}adjustBoardOrientation(){this.coordinator.humanIsFront&&(!this.blackPlayer?.isEngine()&&this.whitePlayer?.isEngine()?this.onFlipBoard(!1):this.blackPlayer?.isEngine()&&!this.whitePlayer?.isEngine()&&this.onFlipBoard(!0))}nextMove(){if(this.state!=="active")return;if(this.coordinator.maxMoves&&this.recordManager.record.current.ply>=this.coordinator.maxMoves&&!this.recordManager.record.current.isCheck&&!this.recordManager.record.current.prev?.isCheck){this.end(f.IMPASS);return}this.getActiveClock().start();const e=this.recordManager.record.position.color,t=this.getPlayer(e),i=this.getPlayer(Oe(e));if(!t||!i){this.onError(new Error("GameManager#nextMove: プレイヤーが初期化されていません。"));return}const r=this.issueEventID(),o={black:{timeMs:this.blackClock.timeMs,byoyomi:this.blackClock.settings.byoyomi||0,increment:this.blackClock.settings.increment||0},white:{timeMs:this.whiteClock.timeMs,byoyomi:this.whiteClock.settings.byoyomi||0,increment:this.whiteClock.settings.increment||0}};t.startSearch(this.recordManager.record.position,this.recordManager.record.usi,o,{onMove:(a,c)=>this.onMove(r,a,c),onResign:()=>this.onResign(r),onWin:()=>this.onWin(r),onError:a=>this.onError(a)}).catch(a=>{this.onError(new Error(`GameManager#nextMove: ${h.failedToSendGoCommand}: ${a}`))}),i.startPonder(this.recordManager.record.position,this.recordManager.record.usi,o).catch(a=>{this.onError(new Error(`GameManager#nextMove: ${h.failedToSendPonderCommand}: ${a}`))})}onMove(e,t,i){if(e!==this.lastEventID){p.log(k.ERROR,"GameManager#onMove: event ID already disabled");return}if(this.state!=="active"){p.log(k.ERROR,"GameManager#onMove: invalid state: "+this.state);return}if(!this.recordManager.record.position.isValidMove(t)){this.onError("反則手: "+ce(this.recordManager.record.position,t)),this.end(f.FOUL_LOSE);return}if(this.getActiveClock().stop(),this.recordManager.appendMove({move:t,moveOption:{ignoreValidation:!0},elapsedMs:this.getActiveClock().elapsedMs}),i&&this.updateSearchInfo(C.PLAYER,i),i&&this.coordinator.enableComment){const o=t.color===S.BLACK?this.blackPlayerSettings.name:this.whitePlayerSettings.name;this.recordManager.appendSearchComment(C.PLAYER,this.coordinator.searchCommentFormat,i,q.APPEND,{engineName:o})}this.onPieceBeat();const r=this.recordManager.record.perpetualCheck;if(r)if(r===this.recordManager.record.position.color){this.end(f.FOUL_LOSE);return}else{this.end(f.FOUL_WIN);return}else if(this.recordManager.record.repetition){this.end(f.REPETITION_DRAW);return}if(this.coordinator.jishogiRule==oe.TRY&&t.pieceType===m.KING&&(t.color===S.BLACK&&t.to.equals(new B(5,1))||t.color===S.WHITE&&t.to.equals(new B(5,9)))){this.end(f.TRY);return}this.nextMove()}onResign(e){if(e!==this.lastEventID){p.log(k.ERROR,"GameManager#onResign: event ID already disabled");return}if(this.state!=="active"){p.log(k.ERROR,"GameManager#onResign: invalid state: "+this.state);return}this.end(f.RESIGN)}onWin(e){if(e!==this.lastEventID){p.log(k.ERROR,"GameManager#onWin: event ID already disabled");return}if(this.state!=="active"){p.log(k.ERROR,"GameManager#onWin: invalid state: "+this.state);return}const t=this.recordManager.record.position;if(this.coordinator.jishogiRule==oe.NONE||this.coordinator.jishogiRule==oe.TRY){this.end(f.FOUL_LOSE);return}const i=this.coordinator.jishogiRule==oe.GENERAL24?J.GENERAL24:J.GENERAL27;switch(X(i,t,t.color)){case de.WIN:this.end(f.ENTERING_OF_KING);break;case de.DRAW:this.end(f.DRAW);break;case de.LOSE:this.end(f.FOUL_LOSE);break}}timeout(e){this.onStopBeep();const t=this.getPlayer(e);if(t?.isEngine()&&!this.coordinator.enableEngineTimeout){t.stop().catch(i=>{this.onError(new Error(`GameManager#timeout: ${h.failedToSendStopCommand}: ${i}`))});return}this.end(f.TIMEOUT)}stop(){const e=setInterval(()=>{switch(this.state){case"active":case"pending":clearInterval(e),this.end(f.INTERRUPT);break;case"idle":clearInterval(e);break}},100)}end(e){if(this.state!=="active"&&this.state!=="pending")return;this.state="busy";const t=this.recordManager.record.position.color;Promise.resolve().then(()=>this.sendGameResult(t,e)).then(()=>{this.getActiveClock().pause(),this.recordManager.appendMove({move:e,elapsedMs:this.getActiveClock().elapsedMs}),this.recordManager.setGameEndMetadata();const i=this.addGameResults(t,e);i&&this.currentGameConditions&&this.onGameResult({gameIndex:this.currentGameConditions.gameIndex,pairIndex:this.currentGameConditions.pairIndex,result:i}),this.coordinator.enableAutoSave&&this.onSaveRecord(this.coordinator.autoSaveDirectory);const r=this.coordinator.next(this.recordManager);if(r instanceof Error&&this.onError(new Error(`GameManager#end: ${r.message}`)),e===f.INTERRUPT||r===null||r instanceof Error){this.closePlayers().catch(a=>{this.onError(a)}).finally(()=>{this.state="idle",this.onClosed(this.results,e)});return}this.state="starting",this.goNextGame(r).catch(a=>{this.onError(new Error(`GameManager#end: ${h.failedToStartNewGame}: ${a}`))})}).catch(i=>{this.onError(new Error(`GameManager#end: ${h.errorOccuredWhileEndingGame}: ${i}`)),this.state="pending"})}updateSearchInfo(e,t){this.state==="active"&&this.recordManager.updateSearchInfo(e,t)}addGameResults(e,t){const i=this.swapped?S.WHITE:S.BLACK,r=ge(e,i,t);switch(r){case y.WIN:this._results.player1.win++,i===S.BLACK?this._results.player1.winBlack++:this._results.player1.winWhite++;break;case y.LOSE:this._results.player2.win++,i===S.BLACK?this._results.player2.winWhite++:this._results.player2.winBlack++;break;case y.DRAW:this._results.draw++;break;default:this._results.invalid++;break}return this._results.total++,r}swapPlayers(){this.swapped=!this.swapped,[this.blackPlayerSettings,this.whitePlayerSettings]=[this.whitePlayerSettings,this.blackPlayerSettings],[this.blackTimeLimit,this.whiteTimeLimit]=[this.whiteTimeLimit,this.blackTimeLimit],[this.blackPlayer,this.whitePlayer]=[this.whitePlayer,this.blackPlayer]}async sendGameResult(e,t){if(this.blackPlayer){const i=ge(e,S.BLACK,t);i&&await this.blackPlayer.gameover(i)}if(this.whitePlayer){const i=ge(e,S.WHITE,t);i&&await this.whitePlayer.gameover(i)}}async closePlayers(){const e=[];this.blackPlayer&&(e.push(this.blackPlayer.close()),this.blackPlayer=void 0),this.whitePlayer&&(e.push(this.whitePlayer.close()),this.whitePlayer=void 0);try{await Promise.all(e)}catch(t){throw new Error(`GameManager#closePlayers: ${h.failedToShutdownEngines}: ${t}`)}}getPlayer(e){switch(e){case S.BLACK:return this.blackPlayer;case S.WHITE:return this.whitePlayer}}getActiveClock(){switch(this.recordManager.record.position.color){case S.BLACK:return this.blackClock;case S.WHITE:return this.whiteClock}}issueEventID(){return this.lastEventID+=1,this.lastEventID}}function ge(s,e,t){switch(t){case f.FOUL_WIN:case f.ENTERING_OF_KING:return s==e?y.WIN:y.LOSE;case f.RESIGN:case f.MATE:case f.TIMEOUT:case f.FOUL_LOSE:case f.TRY:return s==e?y.LOSE:y.WIN;case f.IMPASS:case f.REPETITION_DRAW:return y.DRAW}return null}function ze(){return{timeUnitMs:1e3,totalTime:0,byoyomi:0,delay:0,increment:0}}function Js(){return{id:"",myColor:S.BLACK,toMove:S.BLACK,position:"",players:{black:{time:ze()},white:{time:ze()}}}}var x=(s=>(s.UNKNOWN="unknown",s.RESIGN="resign",s.SENNICHITE="sennichite",s.OUTE_SENNICHITE="oute_sennichite",s.ILLEGAL_MOVE="illegal_move",s.ILLEGAL_ACTION="illegal_action",s.TIME_UP="time_up",s.JISHOGI="jishogi",s.MAX_MOVES="max_moves",s))(x||{}),W=(s=>(s.WIN="win",s.LOSE="lose",s.DRAW="draw",s.CENSORED="censored",s.CHUDAN="chudan",s))(W||{});const Gi="gserver.computer-shogi.org",Bi="wdoor.c.u-tokyo.ac.jp";function Ui(s){return/^floodgate-[0-9]+-[0-9]+F?$/.test(s.split(",")[0])}function Hi(s){return/^[^,]+-[0-9]+-[0-9]+F?(-[BWbw])?,/.test(s)}const js=10;var ct=(s=>(s[s.OFFLINE=0]="OFFLINE",s[s.PLAYER_SETUP=1]="PLAYER_SETUP",s[s.WAITING_LOGIN=2]="WAITING_LOGIN",s[s.LOGIN_FAILED=3]="LOGIN_FAILED",s[s.LOGIN_RETRY_INTERVAL=4]="LOGIN_RETRY_INTERVAL",s[s.READY=5]="READY",s[s.GAME=6]="GAME",s))(ct||{});class zs{constructor(e,t,i){this.recordManager=e,this.blackClock=t,this.whiteClock=i}_state=0;_settings=Yt();_sessionID=0;stopRequested=!1;repeat=0;player;gameSummary=Js();searchInfo;playerBuilder=se();retryTimer;onSaveRecord=()=>{};onGameNext=()=>{};onNewGame=()=>{};onClosed=()=>{};onLoginRetry=()=>{};onFlipBoard=()=>{};onPieceBeat=()=>{};onBeepShort=()=>{};onBeepUnlimited=()=>{};onStopBeep=()=>{};onError=()=>{};on(e,t){switch(e){case"saveRecord":this.onSaveRecord=t;break;case"gameNext":this.onGameNext=t;break;case"newGame":this.onNewGame=t;break;case"closed":this.onClosed=t;break;case"loginRetry":this.onLoginRetry=t;break;case"flipBoard":this.onFlipBoard=t;break;case"pieceBeat":this.onPieceBeat=t;break;case"beepShort":this.onBeepShort=t;break;case"beepUnlimited":this.onBeepUnlimited=t;break;case"stopBeep":this.onStopBeep=t;break;case"error":this.onError=t;break}return this}get state(){return this._state}get settings(){return this._settings}get sessionID(){return this._sessionID}get usiSessionID(){return this.player instanceof ie?this.player.sessionID:0}get isMyTurn(){return this.recordManager.record.position.color===this.gameSummary.myColor}get waitingForHumanPlayerMove(){return this.isMyTurn&&this.settings.player.uri===Ae}async login(e,t){if(this.sessionID)throw new Error("CSAGameManager#login: session already exists");if(this._state!==0)throw new Error("CSAGameManager#login: unexpected state");this._state=1,this._settings=e,this.playerBuilder=t,this.repeat=0;try{this.player=await this.playerBuilder.build(this._settings.player,i=>this.recordManager.updateSearchInfo(C.OPPONENT,i))}catch(i){throw this._state=0,i}this.doLogin().catch(this.onError)}async relogin(){if(this.settings.restartPlayerEveryGame){this._state=1,this.player&&(await this.player.close(),this.player=void 0);try{this.player=await this.playerBuilder.build(this._settings.player,e=>this.recordManager.updateSearchInfo(C.OPPONENT,e))}catch(e){throw this._state=3,this.close(1),e}}await this.doLogin()}async doLogin(){if(!this.player)throw new Error("CSAGameManager#login: player is not initialized");try{this._state=1,await this.player.readyNewGame(),this._state=2;const e=await p.csaLogin(this._settings.server);this._sessionID=e,this._state=5,Qs(this.sessionID,this),this.onGameNext()}catch(e){throw this._state=3,this.close(1),new Error(`CSAGameManager#login: ${h.failedToStartNewGame}: ${e}`)}}stop(){this.sessionID&&(this.stopRequested=!0,p.csaStop(this.sessionID))}logout(){this.close(0)}close(e){if(!(this._state===0||this._state===2)){if(this._state===6&&this.settings.enableAutoSave&&this.onSaveRecord(this.settings.autoSaveDirectory),this.stopRequested&&(e=0,this.stopRequested=!1),this.sessionID&&(Xs(this.sessionID),p.csaLogout(this.sessionID).catch(t=>{this.onError(new Error(`CSAGameManager#close: ${h.errorOccuredWhileLogoutFromCSAServer}: ${t}`))}),this._sessionID=0),this.blackClock.stop(),this.whiteClock.stop(),this._state=0,this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=void 0),e===0||this.repeat>=this.settings.repeat){this.player&&(this.player.close().catch(t=>{this.onError(new Error(`CSAGameManager#close: ${h.failedToShutdownEngines}: ${t}`))}),this.player=void 0),this.onClosed();return}e===2?this.relogin().catch(this.onError):(this._state=4,this.onLoginRetry(),this.retryTimer=setTimeout(()=>this.relogin().catch(this.onError),js*1e3))}}onGameSummary(e){this.gameSummary=e;const t=this.recordManager.importRecord(this.gameSummary.position,{type:b.CSA});if(t){this.onError(`CSAGameManager#onGameSummary: ${t}`),this.close(0);return}this.recordManager.changePly(Number.MAX_SAFE_INTEGER),p.csaAgree(this.sessionID,this.gameSummary.id)}onReject(){this.close(1)}onStart(e){this.repeat++,this.onNewGame(this.repeat);const t=this.gameSummary.players.black.time,i=this.gameSummary.players.white.time;this.recordManager.setGameStartMetadata({gameTitle:this.gameSummary.id,blackName:this.gameSummary.players.black.playerName,whiteName:this.gameSummary.players.white.playerName,blackTimeLimit:{timeSeconds:t.totalTime*t.timeUnitMs/1e3,byoyomi:t.byoyomi*t.timeUnitMs/1e3,increment:t.increment*t.timeUnitMs/1e3},whiteTimeLimit:{timeSeconds:i.totalTime*i.timeUnitMs/1e3,byoyomi:i.byoyomi*i.timeUnitMs/1e3,increment:i.increment*i.timeUnitMs/1e3}}),this.settings.autoFlip&&this.onFlipBoard&&this.onFlipBoard(this.gameSummary.myColor===S.WHITE),this._state=6,this.next(e)}onMove(e,t){const i=this.isMyTurn,r=Ze(this.recordManager.record.position,e);if(r instanceof Error){this.onError(`CSAGameManager#onMove: 解釈できない指し手 [${e}]: ${r.message}`);return}if(this.recordManager.appendMove({move:r,moveOption:{ignoreValidation:!0},elapsedMs:this.parseElapsedMs(r.color,e)}),i&&this.searchInfo&&this.recordManager.updateSearchInfo(C.PLAYER,this.searchInfo),i&&this.searchInfo&&this.settings.enableComment){const o=this.gameSummary.players[r.color].playerName;this.recordManager.appendSearchComment(C.PLAYER,this.settings.searchCommentFormat,this.searchInfo,q.APPEND,{engineName:o})}this.onPieceBeat(),this.next(t)}parseElapsedMs(e,t){const i=this.gameSummary.players[e].time,r=/^.*,T([0-9]+)$/.exec(t);return r?Number(parseInt(r[1]))*i.timeUnitMs:0}onGameResult(e,t){if(this.recordManager.appendMove({move:this.gameResultToSpecialMove(e,t)}),this.player){let i;switch(t){case W.WIN:i=y.WIN;break;case W.LOSE:i=y.LOSE;break;case W.DRAW:case W.CENSORED:case W.CHUDAN:i=y.DRAW;break}this.player.gameover(i)}this.close(2)}gameResultToSpecialMove(e,t){const i=this.recordManager.record.position.color;switch(e){case x.RESIGN:return f.RESIGN;case x.SENNICHITE:return f.REPETITION_DRAW;case x.OUTE_SENNICHITE:case x.ILLEGAL_MOVE:case x.ILLEGAL_ACTION:switch(t){case W.WIN:return i===this.gameSummary.myColor?f.FOUL_WIN:f.FOUL_LOSE;case W.LOSE:return i===this.gameSummary.myColor?f.FOUL_LOSE:f.FOUL_WIN}break;case x.TIME_UP:return f.TIMEOUT;case x.JISHOGI:return f.ENTERING_OF_KING;case x.MAX_MOVES:return f.IMPASS}return t===W.DRAW?f.DRAW:f.INTERRUPT}onClose(){this.close(this.settings.autoRelogin?1:0)}next(e){this.blackClock.stop(),this.whiteClock.stop(),this.syncClock(e),this.startClock(),this.recordManager.record.position.color===this.gameSummary.myColor?this.startSearch(e):this.startPonder()}syncClock(e){const t={onBeepShort:()=>this.onBeepShort(),onBeepUnlimited:()=>this.onBeepUnlimited(),onStopBeep:()=>this.onStopBeep()},i=this.gameSummary.players.black.time;this.blackClock.setup({...t,timeMs:e.black.time*i.timeUnitMs,byoyomi:i.byoyomi*i.timeUnitMs/1e3});const r=this.gameSummary.players.white.time;this.whiteClock.setup({...t,timeMs:e.white.time*r.timeUnitMs,byoyomi:r.byoyomi*r.timeUnitMs/1e3})}startClock(){this.recordManager.record.position.color===S.BLACK?this.blackClock.start():this.whiteClock.start()}startSearch(e){if(!this.player){this.onError("CSAGameManager#startSearch: player is not initialized");return}this.player.startSearch(this.recordManager.record.position,this.recordManager.record.usi,this.buildTimeStates(e),{onMove:this.onPlayerMove.bind(this),onResign:this.onPlayerResign.bind(this),onWin:this.onPlayerWin.bind(this),onError:this.onPlayerError.bind(this)}).catch(t=>{this.onError(new Error(`CSAGameManager#startSearch: ${h.failedToSendGoCommand}: ${t}`))})}startPonder(){if(!this.player){this.onError("CSAGameManager#startPonder: player is not initialized");return}this.player.startPonder(this.recordManager.record.position,this.recordManager.record.usi,this.buildTimeStates()).catch(e=>{this.onError(new Error(`CSAGameManager#startPonder: ${h.failedToSendPonderCommand}: ${e}`))})}startEarlyPonder(e){if(!this.player){this.onError("CSAGameManager#startEarlyPonder: player is not initialized");return}const t=this.recordManager.record.position.clone(),i=this.recordManager.record.usi+" "+e.usi;if(!t.doMove(e)){this.onError("CSAGameManager#startEarlyPonder: failed to make a move");return}this.player.startPonder(t,i,this.buildTimeStates()).catch(r=>{this.onError(new Error(`CSAGameManager#startEarlyPonder: ${h.failedToSendPonderCommand}: ${r}`))})}buildTimeStates(e){const t=this.gameSummary.players.black.time,i=this.gameSummary.players.white.time;return{black:{timeMs:e?e.black.time*t.timeUnitMs:this.blackClock.timeMs,byoyomi:t.byoyomi*t.timeUnitMs/1e3,increment:t.increment*t.timeUnitMs/1e3},white:{timeMs:e?e.white.time*i.timeUnitMs:this.whiteClock.timeMs,byoyomi:i.byoyomi*i.timeUnitMs/1e3,increment:i.increment*i.timeUnitMs/1e3}}}onPlayerMove(e,t){this.searchInfo=t;let i,r;switch(this._settings.server.protocolVersion){case Fe.V121:break;case Fe.V121_FLOODGATE:i=t?.score,t?.pv?.forEach(o=>{r=r?r+" ":"",r+=Me(o)});break}p.csaMove(this.sessionID,Me(e),i,r),this.settings.player.usi?.enableEarlyPonder&&this.startEarlyPonder(e)}onPlayerResign(){p.csaResign(this.sessionID)}onPlayerWin(){p.csaWin(this.sessionID)}onPlayerError(e){this.onError(e)}}const V={};function Qs(s,e){V[s]=e}function Xs(s){delete V[s]}function Zs(s,e){V[s]?.onGameSummary(e)}function ei(s){V[s]?.onReject()}function ti(s,e){V[s]?.onStart(e)}function si(s,e,t){V[s]?.onMove(e,t)}function ii(s,e,t){V[s]?.onGameResult(e,t)}function ri(s){V[s]?.onClose()}class he{_settings={timeMs:0,byoyomi:0,increment:0};_timeMs=0;_byoyomi=0;_elapsedMs=0;timerHandle=0;timerStart=0;lastTimeMs=0;setup(e){this._settings=e,this._timeMs=e.timeMs||0,this._byoyomi=e.byoyomi||0,this._elapsedMs=0}get settings(){return this._settings}get time(){return Math.ceil(this._timeMs/1e3)}get timeMs(){return this._timeMs}get byoyomi(){return this._byoyomi}get elapsedMs(){return this._elapsedMs}start(){this.clearTimer(),this.timerStart=Date.now(),this.lastTimeMs=this._timeMs,this._byoyomi=this.settings.byoyomi||0,this._elapsedMs=0,this.timerHandle=window.setInterval(()=>{const e=this.timeMs,t=this.byoyomi;this._elapsedMs=Date.now()-this.timerStart;const i=this.lastTimeMs-this._elapsedMs;if(i>=0?this._timeMs=i:(this._timeMs=0,this._byoyomi=Math.max(Math.ceil((this.settings.byoyomi||0)+i/1e3),0)),this.timeMs===0&&this.byoyomi===0){this.timeout();return}this.fireBeep(e,t)},100)}fireBeep(e,t){let i=Math.ceil(this.timeMs/1e3),r=Math.ceil(e/1e3);if(!(i!==0&&this.byoyomi!==0)){if(i===0&&r!==0){this.settings.onBeepShort&&this.settings.onBeepShort();return}this.byoyomi!==0&&(i=this.byoyomi,r=t),i!==r&&(i<=5?this.settings.onBeepUnlimited&&this.settings.onBeepUnlimited():(i<=10||i===20||i===30||i===60)&&this.settings.onBeepShort&&this.settings.onBeepShort())}}pause(){this.clearTimer()}stop(){this.clearTimer(),this.incrementTime()}timeout(){this.clearTimer(),this.settings.onTimeout?.()}clearTimer(){this.timerHandle&&(window.clearInterval(this.timerHandle),this.timerHandle=0),this.settings.onStopBeep?.()}incrementTime(){this._timeMs+=(this.settings.increment||0)*1e3}}function oi(s,e,t){const i=s.clone();let r,o="",a=0;for(;a<e.length&&a<t;a++){const c=i.createMoveByUSI(e[a]);if(!c)break;o+=ce(i,c,{lastMove:r}),i.doMove(c,{ignoreValidation:!0}),r=c}for(;a<e.length&&a<t;a++)o+=" "+e[a];return a<e.length&&(o+=" ..."),o}let ai=0;class ni{constructor(e,t){this.sessionID=e,this.name=t}sfen="";nodes;nps;infoList=[];hashfull;currentMove;currentMoveText;ponderMove;refreshOnNextUpdate=!1;get latestInfo(){const e=[],t=new Set,i=new Set;for(const r of this.infoList){const o=r.pv?r.pv[0]:void 0;if(o&&t.has(r.multiPV))break;t.add(r.multiPV),i.has(o)||(e.push(r),i.add(o))}return e.sort((r,o)=>(r.multiPV||1)-(o.multiPV||1))}update(e,t,i,r){(this.sfen!==e||this.refreshOnNextUpdate)&&(this.sfen=e,this.nodes=void 0,this.nps=void 0,this.infoList=[],this.hashfull=void 0,this.currentMove=void 0,this.currentMoveText=void 0,this.ponderMove=void 0,this.refreshOnNextUpdate=!1);const o=ne.newBySFEN(e);if(!o)return;const a={id:ai++,position:e,color:o.color},c=3;if(t.depth!==void 0&&(a.depth=t.depth),t.seldepth!==void 0&&(a.selectiveDepth=t.seldepth),t.timeMs!==void 0&&(a.timeMs=t.timeMs),t.nodes!==void 0&&(this.nodes=t.nodes),t.pv&&(a.pv=t.pv,a.text=oi(o,t.pv,i)),t.multipv!==void 0&&(a.multiPV=t.multipv),t.scoreCP!==void 0&&(a.score=t.scoreCP),t.scoreMate!==void 0&&(a.scoreMate=t.scoreMate),t.lowerbound!==void 0&&(a.lowerBound=t.lowerbound),t.upperbound!==void 0&&(a.upperBound=t.upperbound),t.currmove!==void 0){this.currentMove=t.currmove;const d=o.createMoveByUSI(t.currmove);d&&(this.currentMoveText=ce(o,d))}t.hashfullPerMill!==void 0&&(this.hashfull=t.hashfullPerMill/1e3),t.nps!==void 0&&(this.nps=t.nps),t.string&&(a.text=t.string),this.ponderMove=r&&ce(o,r),Object.keys(a).length!==c&&(t.nodes!==void 0&&(a.nodes=t.nodes),this.infoList.unshift(a))}endIteration(){this.refreshOnNextUpdate=!0}}class ci{_sessions=[];updateQueue=[];timeoutHandle;get sessions(){return this._sessions}update(e,t,i,r,o,a){this.updateQueue.push({sessionID:e,sfen:t.sfen,name:i,info:r,maxPVLength:o,ponderMove:a}),this.timeoutHandle||(this.timeoutHandle=window.setTimeout(()=>{this.dequeue()},500))}dequeue(){this._sessions=this._sessions.filter(e=>Hs(e.sessionID)||this.updateQueue.some(t=>t.sessionID===e.sessionID));for(const e of this.updateQueue)this._update(e);this.updateQueue=[],clearTimeout(this.timeoutHandle),this.timeoutHandle=void 0}_update(e){let t=this._sessions.find(i=>i.sessionID===e.sessionID);t||(t=this.addSession(e.sessionID,e.name)),t.update(e.sfen,e.info,e.maxPVLength,e.ponderMove)}addSession(e,t){const i=new ni(e,t);return this.sessions.push(i),this.sessions.sort((r,o)=>r.sessionID-o.sessionID),i}endIteration(e){const t=this._sessions.find(i=>i.sessionID===e);t&&setTimeout(()=>{this.dequeue(),t.endIteration()})}}var n=(s=>(s.NORMAL="normal",s.PASTE_DIALOG="pasteDialog",s.POSITION_EDITING="positionEditing",s.PIECE_SET_CHANGE_DIALOG="pieceSetChangeDialog",s.EXPORT_POSITION_IMAGE_DIALOG="exportBoardImageDialog",s.GAME_DIALOG="gameDialog",s.GAME="game",s.PARALLEL_GAME="parallelGame",s.CSA_GAME_DIALOG="csaGameDialog",s.CSA_GAME="csaGame",s.ANALYSIS="analysis",s.ANALYSIS_DIALOG="analysisDialog",s.MATE_SEARCH="mateSearch",s.MATE_SEARCH_DIALOG="mateSearchDialog",s.USI_ENGINES_DIALOG="usiEnginesDialog",s.RECORD_FILE_HISTORY_DIALOG="recordFileHistoryDialog",s.BATCH_CONVERSION_DIALOG="batchConversionDialog",s.LAUNCH_USI_ENGINE_DIALOG="launchUsiEngineDialog",s.CONNECT_TO_CSA_SERVER_DIALOG="connectToCsaServerDialog",s.LOAD_REMOTE_FILE_DIALOG="loadRemoteFileDialog",s.SHARE_DIALOG="shareDialog",s.ADD_BOOK_MOVES_DIALOG="addBookMovesDialog",s.SEARCH_DUPLICATE_POSITIONS_DIALOG="searchDuplicatePositionsDialog",s.ELAPSED_TIME_CHART_DIALOG="elapsedTimeChartDialog",s))(n||{}),N=(s=>(s.IDLE="idle",s.STARTUP_DIALOG="startupDialog",s.RUNNING="running",s))(N||{});class hi{constructor(e){this.recordManager=e}researcher;settings=qt();lastSearchInfo;searchInfo;timerHandle;onFinish=()=>{};onError=()=>{};on(e,t){switch(e){case"finish":this.onFinish=t;break;case"error":this.onError=t;break}return this}async start(e){if(!e.usi)throw new Error("エンジンが設定されていません。");await this.setupEngine(e.usi),this.settings=e,this.lastSearchInfo=void 0,this.searchInfo=void 0,this.recordManager.changePly(this.firstPly()),this.settings.descending&&!(this.recordManager.record.current.move instanceof j)&&this.recordManager.goBack(),setTimeout(()=>this.search())}firstPly(){return this.settings.descending?this.settings.endCriteria.enableNumber?this.settings.endCriteria.number:this.recordManager.record.length:this.settings.startCriteria.enableNumber?this.settings.startCriteria.number-1:0}close(){this.clearTimer(),this.closeEngine().catch(e=>{this.onError(e)})}async setupEngine(e){if(this.researcher)throw new Error("AnalysisManager#setupEngine: 前回のエンジンが終了していません。数秒待ってからもう一度試してください。");const t=_(),i=new ie(e,{timeoutSeconds:t.engineTimeoutSeconds},this.updateSearchInfo.bind(this));await i.launch(),await i.readyNewGame(),this.researcher=i}async closeEngine(){this.researcher&&(await this.researcher.close(),this.researcher=void 0)}searchNextPosition(){const e=this.recordManager.record.current.ply;if(this.settings.descending){if(this.recordManager.goBack(),this.settings.startCriteria.enableNumber&&this.recordManager.record.current.ply<this.settings.startCriteria.number-1){this.finish();return}}else if(this.recordManager.goForward(),this.settings.endCriteria.enableNumber&&this.recordManager.record.current.ply>this.settings.endCriteria.number){this.finish();return}if(this.recordManager.record.current.ply===e){this.finish();return}this.search()}search(){if(this.clearTimer(),!this.researcher){this.onError(new Error("エンジンが初期化されていません。")),this.finish();return}this.lastSearchInfo=this.searchInfo,this.searchInfo=void 0;const e=this.recordManager.record;if(!e.current.next&&!(e.current.move instanceof j)){this.finish();return}this.setTimer(),this.researcher.startResearch(this.recordManager.record.position,this.recordManager.record.usi).catch(t=>{this.onError(t)})}finish(){this.onFinish(),this.close()}setTimer(){this.timerHandle=window.setTimeout(()=>{this.onResult(),this.searchNextPosition()},this.settings.perMoveCriteria.maxSeconds*1e3)}clearTimer(){this.timerHandle&&(clearTimeout(this.timerHandle),this.timerHandle=void 0)}onResult(){if(!this.searchInfo||!this.lastSearchInfo)return;const e=this.settings.descending?this.searchInfo:this.lastSearchInfo,t=this.settings.descending?this.lastSearchInfo:this.searchInfo,i=this.recordManager.record.current.ply;this.settings.descending&&this.recordManager.changePly(i+1);const o=Oe(this.recordManager.record.position.color)===S.BLACK?1:-1,a=t.score!==void 0?t.score*o:void 0,c=t.score!==void 0&&e.score!==void 0?(t.score-e.score)*o:void 0,d=this.recordManager.record.current.move,u=d instanceof j&&e.pv?d.equals(e.pv[0]):!1,g=_();let P="";if(c!==void 0&&a!==void 0&&!u){const E=li(a-c,a,g);E&&(P=`【${E}】`)}this.recordManager.appendSearchComment(C.RESEARCHER,g.searchCommentFormat,t,this.settings.commentBehavior,{header:P,engineName:this.settings.usi?.name}),this.settings.descending&&this.recordManager.changePly(i)}updateSearchInfo(e){this.recordManager.updateSearchInfo(C.RESEARCHER,e),this.searchInfo=e}}function li(s,e,t){const i=qe(s,t.coefficientInSigmoid)-qe(e,t.coefficientInSigmoid);return i>=t.badMoveLevelThreshold4?h.blunder:i>=t.badMoveLevelThreshold3?h.mistake:i>=t.badMoveLevelThreshold2?h.dubious:i>=t.badMoveLevelThreshold1?h.inaccuracy:null}function di(s){switch(s){case 0:return C.RESEARCHER;case 1:return C.RESEARCHER_2;case 2:return C.RESEARCHER_3;case 3:return C.RESEARCHER_4;default:return}}class ui{settings=Jt();engines=[];ready=!1;onUpdateSearchInfo=()=>{};onError=()=>{};record;lazyPositionUpdate=new ns;synced=!0;on(e,t){switch(e){case"updateSearchInfo":this.onUpdateSearchInfo=t;break;case"error":this.onError=t;break}return this}async launch(e){if(this.settings=e,e.usi===void 0)throw new Error("ResearchManager#launch: USIエンジンの設定は必須です。");for(const r of e.secondaries||[])if(r.usi===void 0)throw new Error("ResearchManager#launch: USIエンジンの設定は必須です。");if(this.engines.length>0)throw new Error("ResearchManager#launch: 前回のエンジンが終了していません。数秒待ってからもう一度試してください。");const t=_(),i=[e.usi,...e.secondaries?.map(r=>r.usi)||[]];this.engines=i.map((r,o)=>{const a=r.options;e.overrideMultiPV&&(a[Te]?.type==="spin"?a[Te].value=e.multiPV:a[ye]?.type==="spin"&&(a[ye].value=e.multiPV));const c={...r,options:a},d=di(o);return{usi:new ie(c,{timeoutSeconds:t.engineTimeoutSeconds},u=>{d!==void 0&&this.synced&&this.onUpdateSearchInfo(d,u)}),paused:!1}});try{await Promise.all(this.engines.map(r=>r.usi.launch())),await Promise.all(this.engines.map(r=>r.usi.readyNewGame())),this.ready=!0}catch(r){throw this.close(),r}}updatePosition(e){this.synced=!1,this.lazyPositionUpdate.after(()=>{this.ready&&(this.engines.forEach(t=>{t.paused||(t.usi.startResearch(e.position,e.usi).catch(i=>{this.onError(i)}),this.setupTimer(t))}),this.synced=!0,this.record=e)},200)}isPaused(e){return this.engines.find(t=>t.usi.sessionID===e)?.paused||!1}pause(e){const t=this.engines.find(i=>i.usi.sessionID===e);t&&(t.paused=!0,t.usi.stop().catch(i=>{this.onError(i)}))}unpause(e){const t=this.engines.find(i=>i.usi.sessionID===e);t&&(t.paused=!1,this.record&&(t.usi.startResearch(this.record.position,this.record.usi).catch(i=>{this.onError(i)}),this.setupTimer(t)))}getMultiPV(e){return this.engines.find(t=>t.usi.sessionID===e)?.usi.multiPV}setMultiPV(e,t){const i=this.engines.find(r=>r.usi.sessionID===e);i?.usi.multiPV&&i.usi.setMultiPV(t).then(()=>i.usi.stop()).then(()=>{this.record&&!i.paused&&(i.usi.startResearch(this.record.position,this.record.usi).catch(r=>{this.onError(r)}),this.setupTimer(i))}).catch(r=>{this.onError(r)})}isSessionExists(e){return this.engines.some(t=>t.usi.sessionID===e)}setupTimer(e){clearTimeout(e.timer),this.settings.enableMaxSeconds&&this.settings.maxSeconds>0&&(e.timer=setTimeout(()=>{e.usi.stop().catch(t=>{this.onError(t)})},this.settings.maxSeconds*1e3))}close(){this.lazyPositionUpdate.clear(),this.engines.forEach(e=>clearTimeout(e.timer)),Promise.allSettled(this.engines.map(e=>e.usi.close())).then(e=>{for(const t of e)t.status==="rejected"&&this.onError(t.reason);this.engines=[],this.ready=!1})}}class mi{engine=null;onNotImplemented=()=>{};onCheckmate=()=>{};onTimeout=()=>{};onNoMate=()=>{};onError=()=>{};on(e,t){switch(e){case"checkmate":this.onCheckmate=t;break;case"notImplemented":this.onNotImplemented=t;break;case"timeout":this.onTimeout=t;break;case"noMate":this.onNoMate=t;break;case"error":this.onError=t;break}return this}async start(e,t){if(e.usi===void 0)throw new Error("MateSearchManager#start: USIエンジンの設定は必須です。");const i=_();this.engine=new ie(e.usi,{timeoutSeconds:i.engineTimeoutSeconds});const r=e.enableMaxSeconds?e.maxSeconds:void 0;try{await this.engine.launch(),await this.engine.readyNewGame(),await this.engine.startMateSearch(t.position,t.usi,r,{onCheckmate:o=>{this.close(),this.onCheckmate(o)},onNotImplemented:()=>{this.close(),this.onNotImplemented()},onTimeout:()=>{this.close(),this.onTimeout()},onNoMate:()=>{this.close(),this.onNoMate()},onError:o=>{this.close(),this.onError(o)}})}catch(o){throw this.close(),o}}close(){this.engine?.close().then(()=>{this.engine=null}).catch(e=>{this.onError(e)})}}function pi(s,e){const t={branch:!1,comment:!1,bookmark:!1,time:!1};if(e===K.KIF||e===K.KIFU)return t;switch(s.forEach(i=>{i.branch&&(t.branch=!0),i.comment&&(t.comment=!0),i.bookmark&&(t.bookmark=!0),i.elapsedMs&&(t.time=!0)}),e){case K.KI2:case K.KI2U:t.branch=!1,t.comment=!1,t.bookmark=!1;break;case K.CSA:t.comment=!1,t.time=!1;break;case K.SFEN:break;case K.JKF:t.branch=!1,t.comment=!1,t.time=!1;break}return t}class fi{count=0;_progress;get isBusy(){return this.count!==0}get progress(){return this._progress}retain(){this.count+=1}release(){this.count-=1,this.count===0&&(this._progress=void 0)}updateProgress(e){this.count&&(this._progress=e)}}function gi(){return ke(new fi)}let Se;function I(){return Se||(Se=gi()),Se}const ht="mobile:record",lt="mobile:ply";function Si(){if(tt())return;const s=new URL(window.location.toString()).searchParams,e=s.get("usen");if(e){const o=parseInt(s.get("branch")||"0",10),a=parseInt(s.get("ply")||"0",10),c=A.newByUSEN(e,o,a);if(c instanceof Error){M().add(`棋譜の読み込み中にエラーが発生しました。: ${c}`);return}const d=s.get("bname")||"",u=s.get("wname")||"";return c.metadata.setStandardMetadata(w.BLACK_NAME,d),c.metadata.setStandardMetadata(w.WHITE_NAME,u),c}if(!st())return;const t=localStorage.getItem(ht);if(t===null)return;const i=Xe(t);if(i instanceof Error)return;const r=Number.parseInt(localStorage.getItem(lt)||"0");return i.goto(r),i}function Ei(){return!!new URL(window.location.toString()).searchParams.get("usen")}function Q(s){if(!st()||Ei())return;const e=we(s);localStorage.setItem(ht,e),localStorage.setItem(lt,s.current.ply.toString())}function Ri(){const s=new URL(window.location.toString());s.searchParams.delete("usen"),s.searchParams.delete("branch"),s.searchParams.delete("ply"),s.searchParams.delete("bname"),s.searchParams.delete("wname"),window.history.replaceState({},"",s.toString())}function _i(s,e,t,i=1e-12,r=100){let o=s(e),a=s(t);if(o*a>0)throw new Error("brentq: f(a) and f(b) must have opposite signs");let c=e,d=o,u=t-e,g=u;for(let P=0;P<r;P++){a*d>0&&(c=e,d=o,u=t-e,g=u),Math.abs(d)<Math.abs(a)&&(e=t,t=c,c=e,o=a,a=d,d=o);const E=2*Number.EPSILON*Math.abs(t)+.5*i,R=.5*(c-t);if(Math.abs(R)<=E||a===0)return t;if(Math.abs(g)>=E&&Math.abs(o)>Math.abs(a)){const U=a/o;let v,D;if(e===c)v=2*R*U,D=1-U;else{const O=o/d,H=a/d;v=U*(2*R*O*(O-H)-(t-e)*(H-1)),D=(O-1)*(H-1)*(U-1)}v>0?D=-D:v=-v,2*v<Math.min(3*R*D-Math.abs(E*D),Math.abs(g*D))?(g=u,u=v/D):(u=R,g=R)}else u=R,g=R;e=t,o=a,Math.abs(u)>E?t+=u:t+=R>0?E:-E,a=s(t)}return t}function Ii(s){const e=s.reduce((i,[r,o])=>i+o*r,0),t=s.reduce((i,[r,o])=>i+o*(r-e)**2,0);return{mean:e,variance:t}}const Mi=Math.SQRT2*Math.log(10)/800;function Qe(s,e){const t=e*Mi,i=.5,r=s.length;let o=s.map(([a])=>[a,1/r]);for(let a=0;a<16;a++){const{mean:c,variance:d}=Ii(o),u=Math.sqrt(d);if(u<1e-15)break;const g=o.map(([O])=>O-i-.5*t*u*(1+((O-c)/u)**2)),P=Math.min(...g),E=Math.max(...g);if(P*E>=0)break;const R=1e-9,U=_i(O=>s.reduce((H,[,z],De)=>H+z*g[De]/(1+O*g[De]),0),-1/E+R,-1/P-R),v=s.map(([O,H],z)=>[O,H/(1+U*g[z])]),D=v.reduce((O,[,H],z)=>O+Math.abs(H-o[z][1]),0);if(o=v,D<1e-10)break}return o}function Ti(s,e){const t=Math.log((1-e.beta)/e.alpha),i=Math.log(e.beta/(1-e.alpha)),o=[s.loseLose,s.loseDraw,s.drawDrawOrWinLose,s.winDraw,s.winWin].map(E=>E===0?.001:E),a=o.reduce((E,R)=>E+R,0),c=o.map((E,R)=>[R/4,E/a]),d=Qe(c,e.elo0),u=Qe(c,e.elo1),g=c.reduce((E,[,R],U)=>E+R*(Math.log(u[U][1])-Math.log(d[U][1])),0);return{llr:a*g,lowerBound:i,upperBound:t}}class yi{settings=Ne();_workers=[];runningWorkers=0;pairIndexToFirstResult=new Map;pentanomial={loseLose:0,loseDraw:0,drawDrawOrWinLose:0,winDraw:0,winWin:0};sprtSummary=void 0;onProgress=()=>{};onSaveRecord=()=>{};onClosed=()=>{};onError=()=>{};on(e,t){switch(e){case"progress":this.onProgress=t;break;case"saveRecord":this.onSaveRecord=t;break;case"closed":this.onClosed=t;break;case"error":this.onError=t;break}return this}async start(e,t){if(e.parallelism<1)throw new Error("ParallelGameManager#start: settings.parallelism must be 1 or more.");if(this._workers.length>0)throw new Error("ParallelGameManager#start: already started.");this.settings=e;const i=await at({settings:this.settings,currentPly:0});this._workers=[],this.runningWorkers=0,this.pairIndexToFirstResult.clear(),this.pentanomial={loseLose:0,loseDraw:0,drawDrawOrWinLose:0,winDraw:0,winWin:0},this.sprtSummary=void 0;const r=[];for(let o=0;o<e.parallelism;o++){const a=new ot,c=new he,d=new he,u=new nt(a,c,d),g={gameManager:u,gameCount:0};this._workers.push(g);const P=()=>{g.gameCount++,g.currentGameTitle=a.record.metadata.getStandardMetadata(w.TITLE),g.currentBlackPlayerName=a.record.metadata.getStandardMetadata(w.BLACK_NAME),g.currentWhitePlayerName=a.record.metadata.getStandardMetadata(w.WHITE_NAME),g.currentGameStartTime=Date.now(),this.onProgress({workerStats:this._workers,gameResults:this.results,sprtSummary:this.sprtSummary})},E=()=>{if(g.currentGameTitle=void 0,g.currentBlackPlayerName=void 0,g.currentWhitePlayerName=void 0,g.currentGameStartTime=void 0,this.runningWorkers--,this.runningWorkers===0){const R=this.results;this._workers=[],this.onClosed(R,this.sprtSummary)}};u.on("saveRecord",R=>{this.onSaveRecord(R,a)}).on("gameNext",P).on("gameResult",R=>{this.trackPairResult(R.pairIndex,R.result)}).on("closed",E).on("error",R=>{this.onError(R)}),this.runningWorkers++,r.push(u.start(i,t).catch(R=>(this.onError(R),E(),Promise.reject(R))))}Promise.allSettled(r).then(o=>{o.some(a=>a.status==="rejected")&&this.stop()})}stop(){for(const e of this._workers)e.gameManager.stop()}get results(){const e=Ce("","");for(const t of this._workers){const i=t.gameManager.results;e.player1.name=i.player1.name,e.player1.win+=i.player1.win,e.player1.winBlack+=i.player1.winBlack,e.player1.winWhite+=i.player1.winWhite,e.player2.name=i.player2.name,e.player2.win+=i.player2.win,e.player2.winBlack+=i.player2.winBlack,e.player2.winWhite+=i.player2.winWhite,e.draw+=i.draw,e.invalid+=i.invalid,e.total+=i.total}return e}trackPairResult(e,t){const i=this.pairIndexToFirstResult.get(e);if(i===void 0){this.pairIndexToFirstResult.set(e,t);return}this.pairIndexToFirstResult.delete(e);const r=(i===y.WIN?1:0)+(t===y.WIN?1:0),o=(i===y.LOSE?1:0)+(t===y.LOSE?1:0),a=(i===y.DRAW?1:0)+(t===y.DRAW?1:0);if(r===2?this.pentanomial.winWin++:r===1&&a===1?this.pentanomial.winDraw++:o===2?this.pentanomial.loseLose++:o===1&&a===1?this.pentanomial.loseDraw++:this.pentanomial.drawDrawOrWinLose++,this.settings.sprtEnabled&&(this.sprtSummary===void 0||this.sprtSummary.result==="inconclusive")){const{llr:c,lowerBound:d,upperBound:u}=Ti(this.pentanomial,this.settings.sprt);this.sprtSummary={elo0:this.settings.sprt.elo0,elo1:this.settings.sprt.elo1,alpha:this.settings.sprt.alpha,beta:this.settings.sprt.beta,pentanomial:{...this.pentanomial},llr:c,lowerBound:d,upperBound:u,result:"inconclusive"},c>=u?(this.sprtSummary.result="accept",this.stop()):c<=d&&(this.sprtSummary.result="reject",this.stop())}}}function Ee(s,e){const t=qs(s),i=[{text:s.player1.name,children:[`${h.wins}: ${s.player1.win}`,`${h.winsOnBlack}: ${s.player1.winBlack}`,`${h.winsOnWhite}: ${s.player1.winWhite}`]},{text:s.player2.name,children:[`${h.wins}: ${s.player2.win}`,`${h.winsOnBlack}: ${s.player2.winBlack}`,`${h.winsOnWhite}: ${s.player2.winWhite}`]},{text:`${h.draws}: ${s.draw}`},{text:`${h.validGames}: ${s.total-s.invalid}`},{text:`${h.invalidGames}: ${s.invalid}`},{text:`${h.eloRatingDiff} (${h.ignoreDraws})`,children:[`${t.rating.toFixed(2)}`,`95% CI: [${t.ratingLower.toFixed(1)}, ${t.ratingUpper.toFixed(1)}]`]}];return e?i.push({text:"SPRT",children:[`Elo0=${e.elo0.toFixed(2)}, Elo1=${e.elo1.toFixed(2)}`,`alpha=${e.alpha}, beta=${e.beta}`,`5-nomial=[${e.pentanomial.loseLose}, ${e.pentanomial.loseDraw}, ${e.pentanomial.drawDrawOrWinLose}, ${e.pentanomial.winDraw}, ${e.pentanomial.winWin}]`,`LLR=${e.llr.toFixed(4)} [${e.lowerBound.toFixed(4)}, ${e.upperBound.toFixed(4)}]`,e.result]}):i.push({text:"二項検定",children:[`np > 5: ${t.npIsGreaterThan5?"True":"False"}`,`${h.zValue}: ${t.zValue.toFixed(2)}`,`${h.significance5pc}: ${t.significance5pc?"True":"False"}`,`${h.significance1pc}: ${t.significance1pc?"True":"False"}`]}),[{type:"list",items:i}]}let Pi=class{recordManager=new ot(Si());_appState=n.NORMAL;_customLayout=null;_isAppSettingsDialogVisible=!1;_pvPreview;usiMonitor=new ci;blackClock=new he;whiteClock=new he;gameManager=new nt(this.recordManager,this.blackClock,this.whiteClock);parallelGameManager=new yi;_parallelGameProgress;_gameSettings=Ne();csaGameManager=new zs(this.recordManager,this.blackClock,this.whiteClock);analysisManager=new hi(this.recordManager);mateSearchManager=new mi;_researchState=N.IDLE;researchManager=new ui;_reactive;garbledNotified=!1;onChangePositionHandlers=[];onUpdateRecordTreeHandlers=[];onUpdateCustomDataHandlers=[];constructor(){const e=ke(this);this._reactive=e,this.recordManager.on("changePosition",()=>{this.onChangePositionHandlers.forEach(t=>t()),Q(this.record),this.updateResearchPosition()}).on("updateTree",()=>{this.onUpdateRecordTreeHandlers.forEach(t=>t()),Q(this.record),Ri()}).on("updateComment",()=>{Q(this.record)}).on("updateBookmark",()=>{Q(this.record)}).on("updateCustomData",()=>{this.onUpdateCustomDataHandlers.forEach(t=>t()),Q(this.record)}).on("backup",()=>({returnCode:_().returnCode})),this.gameManager.on("saveRecord",this.onSaveRecord.bind(e)).on("closed",this.onGameClosed.bind(e)).on("flipBoard",this.onFlipBoard.bind(e)).on("pieceBeat",()=>me(_().pieceVolume)).on("beepShort",this.onBeepShort.bind(e)).on("beepUnlimited",this.onBeepUnlimited.bind(e)).on("stopBeep",Ye).on("error",t=>{M().add(t)}),this.parallelGameManager.on("progress",this.onParallelGameProgress.bind(e)).on("saveRecord",this.onSaveRecord.bind(e)).on("closed",this.onParallelGameClosed.bind(e)).on("error",t=>{M().add(t)}),this.csaGameManager.on("saveRecord",this.onSaveRecord.bind(e)).on("closed",this.onCSAGameClosed.bind(e)).on("flipBoard",this.onFlipBoard.bind(e)).on("pieceBeat",()=>me(_().pieceVolume)).on("beepShort",this.onBeepShort.bind(e)).on("beepUnlimited",this.onBeepUnlimited.bind(e)).on("stopBeep",Ye).on("error",t=>{M().add(t)}),this.researchManager.on("updateSearchInfo",this.onUpdateSearchInfo.bind(e)).on("error",t=>{M().add(t)}),this.analysisManager.on("finish",this.onFinish.bind(e)).on("error",t=>{M().add(t)}),this.mateSearchManager.on("checkmate",this.onCheckmate.bind(e)).on("notImplemented",this.onNotImplemented.bind(e)).on("noMate",this.onNoMate.bind(e)).on("error",this.onCheckmateError.bind(e)),Ns(this.endUSIIteration.bind(e)),ks(this.updateUSIInfo.bind(e))}addEventListener(e,t){switch(e){case"changePosition":this.onChangePositionHandlers.push(t);break;case"updateRecordTree":this.onUpdateRecordTreeHandlers.push(t);break;case"updateCustomData":this.onUpdateCustomDataHandlers.push(t);break}}removeEventListener(e,t){switch(e){case"changePosition":this.onChangePositionHandlers=this.onChangePositionHandlers.filter(i=>i!==t);break;case"updateRecordTree":this.onUpdateRecordTreeHandlers=this.onUpdateRecordTreeHandlers.filter(i=>i!==t);break;case"updateCustomData":this.onUpdateCustomDataHandlers=this.onUpdateCustomDataHandlers.filter(i=>i!==t);break}}get reactive(){return this._reactive}get record(){return this.recordManager.record}get recordFilePath(){return this.recordManager.recordFilePath}get isRecordFileUnsaved(){return this.recordManager.unsaved}get inCommentPVs(){return this.recordManager.inCommentPVs}get positionCounts(){return this.recordManager.positionCounts}updateStandardRecordMetadata(e){this.recordManager.updateStandardMetadata(e)}appendSearchComment(e,t,i,r){const o=_();this.recordManager.appendSearchComment(e,o.searchCommentFormat,t,i,r)}appendMovesSilently(e,t){return this.recordManager.appendMovesSilently(e,t)}get appState(){return this._appState}get researchState(){return this._researchState}get customLayout(){return this._customLayout}updateLayoutProfile(e){this._customLayout=e}get pvPreview(){return this._pvPreview}showPVPreviewDialog(e){this._pvPreview=e}closePVPreviewDialog(){this._pvPreview=void 0}showPasteDialog(e="standard"){if(this.appState!==n.NORMAL)return;const t=_();e==="standard"&&t.showPasteDialog||!tt()?this._appState=n.PASTE_DIALOG:navigator.clipboard.readText().then(i=>{this.pasteRecord(i,e)})}showGameDialog(){this.appState===n.NORMAL&&(this._appState=n.GAME_DIALOG)}showCSAGameDialog(){this.appState===n.NORMAL&&(this._appState=n.CSA_GAME_DIALOG)}showAnalysisDialog(){this.appState===n.NORMAL&&(this._appState=n.ANALYSIS_DIALOG)}showMateSearchDialog(){this.appState===n.NORMAL&&(this._appState=n.MATE_SEARCH_DIALOG)}showUsiEngineManagementDialog(){this.appState===n.NORMAL&&(this._appState=n.USI_ENGINES_DIALOG)}showRecordFileHistoryDialog(){this.appState===n.NORMAL&&(this._appState=n.RECORD_FILE_HISTORY_DIALOG)}showBatchConversionDialog(){this.appState===n.NORMAL&&(this._appState=n.BATCH_CONVERSION_DIALOG)}showExportBoardImageDialog(){this.appState===n.NORMAL&&(this._appState=n.EXPORT_POSITION_IMAGE_DIALOG)}showLaunchUSIEngineDialog(){this.appState===n.NORMAL&&(this._appState=n.LAUNCH_USI_ENGINE_DIALOG)}showConnectToCSAServerDialog(){this.appState===n.NORMAL&&(this._appState=n.CONNECT_TO_CSA_SERVER_DIALOG)}showLoadRemoteFileDialog(){this.appState===n.NORMAL&&(this._appState=n.LOAD_REMOTE_FILE_DIALOG)}showShareDialog(){this.appState===n.NORMAL&&(this._appState=n.SHARE_DIALOG)}showAddBookMovesDialog(){this.appState===n.NORMAL&&(this._appState=n.ADD_BOOK_MOVES_DIALOG)}showSearchDuplicatePositionsDialog(){this.appState===n.NORMAL&&(this._appState=n.SEARCH_DUPLICATE_POSITIONS_DIALOG)}showElapsedTimeChartDialog(){this.appState===n.NORMAL&&(this._appState=n.ELAPSED_TIME_CHART_DIALOG)}destroyModalDialog(){(this.appState===n.PASTE_DIALOG||this.appState===n.GAME_DIALOG||this.appState===n.CSA_GAME_DIALOG||this.appState===n.ANALYSIS_DIALOG||this.appState===n.MATE_SEARCH_DIALOG||this.appState===n.USI_ENGINES_DIALOG||this.appState===n.EXPORT_POSITION_IMAGE_DIALOG||this.appState===n.RECORD_FILE_HISTORY_DIALOG||this.appState===n.BATCH_CONVERSION_DIALOG||this.appState===n.LAUNCH_USI_ENGINE_DIALOG||this.appState===n.CONNECT_TO_CSA_SERVER_DIALOG||this.appState===n.LOAD_REMOTE_FILE_DIALOG||this.appState===n.SHARE_DIALOG||this.appState===n.ADD_BOOK_MOVES_DIALOG||this.appState===n.SEARCH_DUPLICATE_POSITIONS_DIALOG||this.appState===n.ELAPSED_TIME_CHART_DIALOG)&&(this._appState=n.NORMAL)}closeModalDialog(){I().isBusy||this.destroyModalDialog()}get isAppSettingsDialogVisible(){return this._isAppSettingsDialogVisible}showAppSettingsDialog(){this._isAppSettingsDialogVisible=!0}closeAppSettingsDialog(){this._isAppSettingsDialogVisible=!1}get usiMonitors(){return this.usiMonitor.sessions}get candidates(){const e=_(),t=100,i=this.recordManager.record.position.sfen,r=[],o=new Set;for(const a of this.usiMonitor.sessions){if(a.ponderMove)continue;let c=0,d=-1/0;for(const u of a.latestInfo){if(c>=e.maxArrowsPerEngine||u.multiPV&&u.multiPV>e.maxArrowsPerEngine)break;if(!u.pv?.length)continue;const g=u.score!==void 0?u.score:u.scoreMate?u.scoreMate>0?1e8-u.scoreMate:-1e8-u.scoreMate:void 0;if(g!==void 0){if(g<d-t)continue;g>d&&(d=g)}const P=u.pv[0];if(o.has(P)||u.position!==i)continue;const E=ne.newBySFEN(u.position);if(!E)continue;const R=E.createMoveByUSI(P);!R||!E.doMove(R)||(r.push(R),o.add(P),c++)}}return r}isPausedResearchEngine(e){return this.researchManager.isPaused(e)}pauseResearchEngine(e){this.researchManager.pause(e)}unpauseResearchEngine(e){this.researchManager.unpause(e)}getResearchMultiPV(e){return this.researchManager.getMultiPV(e)}setResearchMultiPV(e,t){this.researchManager.setMultiPV(e,t)}endUSIIteration(e){this.usiMonitor.endIteration(e)}updateUSIInfo(e,t,i,r,o){if(this.appState===n.PARALLEL_GAME)return;const a=_();this.usiMonitor.update(e,t,i,r,a.maxPVTextLength,o)}get blackTime(){return this.blackClock.time}get blackByoyomi(){return this.blackClock.byoyomi}get whiteTime(){return this.whiteClock.time}get whiteByoyomi(){return this.whiteClock.byoyomi}startGame(e){I().isBusy||this.appState!==n.NORMAL&&this.appState!==n.GAME_DIALOG||(I().retain(),p.saveGameSettings(e).then(async()=>{this._gameSettings=e;const t=_();if(e.parallelism>=2||e.sprtEnabled){this._parallelGameProgress=void 0;const i=se({timeoutSeconds:t.engineTimeoutSeconds,discardUSIInfo:!e.enableComment});this._appState=n.PARALLEL_GAME,await this.parallelGameManager.start(e,i)}else{const i=se({timeoutSeconds:t.engineTimeoutSeconds});this._appState=n.GAME,await this.gameManager.startLinear(e,i)}}).catch(t=>{M().add(t),this._appState=n.NORMAL}).finally(()=>{I().release()}))}get gameSettings(){return this._gameSettings}get gameResults(){return this.gameManager.results}get csaGameState(){return this.csaGameManager.state}get csaServerSessionID(){return this.csaGameManager.sessionID}get csaGameSettings(){return this.csaGameManager.settings}get usiSessionIDs(){return this.appState==n.CSA_GAME?[this.csaGameManager.usiSessionID].filter(e=>e):[]}loginCSAGame(e,t){this.appState!==n.CSA_GAME_DIALOG||I().isBusy||(I().retain(),Promise.resolve().then(async()=>{if(t.saveHistory){const i=await p.loadCSAGameSettingsHistory(),r=jt(i,e);await p.saveCSAGameSettingsHistory(r)}}).then(()=>{const i=_(),r=se({timeoutSeconds:i.engineTimeoutSeconds});return this.csaGameManager.login(e,r)}).then(()=>this._appState=n.CSA_GAME).catch(i=>{M().add(i)}).finally(()=>{I().release()}))}cancelCSAGame(){if(this.appState===n.CSA_GAME){if(this.csaGameManager.state===ct.GAME){M().add("対局が始まっているため通信対局をキャンセルできませんでした。");return}this.csaGameManager.logout(),this._appState=n.NORMAL}}stopGame(){switch(this.appState){case n.GAME:this.gameSettings.repeat>=2?this.showConfirmation({message:h.areYouSureWantToQuitGames,onOk:()=>this.gameManager.stop()}):this.gameManager.stop();break;case n.PARALLEL_GAME:this.showConfirmation({message:h.areYouSureWantToQuitGames,onOk:()=>this.parallelGameManager.stop()});break;case n.CSA_GAME:this.showConfirmation({message:h.areYouSureWantToRequestQuit,onOk:()=>this.csaGameManager.stop()});break}}showGameResults(){if(this.appState!==n.GAME)return;const e=this.gameManager.results;L().enqueue({text:h.gameProgress,attachments:Ee(e),withCopyButton:!0})}get parallelGameProgress(){return this._parallelGameProgress}onParallelGameProgress(e){this._parallelGameProgress=e}onGameClosed(e,t){this.appState===n.GAME&&(p.log(k.INFO,`game end: ${JSON.stringify(e)}`),e&&e.total>=2?L().enqueue({text:h.allGamesCompleted,attachments:Ee(e),withCopyButton:!0}):t&&L().enqueue({text:`${h.gameEnded}（${zt(t,this.record.current.nextColor)})`}),this._appState=n.NORMAL)}onParallelGameClosed(e,t){this.appState===n.PARALLEL_GAME&&(L().enqueue({text:h.allGamesCompleted,attachments:Ee(e,t),withCopyButton:!0}),this._appState=n.NORMAL)}onCSAGameClosed(){this.appState===n.CSA_GAME&&(this._appState=n.NORMAL)}onFlipBoard(e){_().boardFlipping!==e&&_().flipBoard()}onSaveRecord(e,t=this.recordManager){const i=_(),r=xe(t.record,{template:i.recordFileNameTemplate,extension:i.defaultRecordFileFormat}),o=Qt(e,r);this.saveRecordByPath(o,{recordManager:t}).catch(a=>{M().add(a)})}onBeepShort(){const e=_();if(!(e.clockSoundTarget===We.ONLY_USER&&!this.isMovableByUser))try{hs({frequency:e.clockPitch,volume:e.clockVolume})}catch(t){M().add(t)}}onBeepUnlimited(){const e=_();if(!(e.clockSoundTarget===We.ONLY_USER&&!this.isMovableByUser))try{ls({frequency:e.clockPitch,volume:e.clockVolume})}catch(t){M().add(t)}}doMove(e){if(this.appState!==n.NORMAL||!this.recordManager.appendMove({move:e}))return;const t=_();try{me(t.pieceVolume)}catch(i){M().add(i)}}onFinish(){this.appState===n.ANALYSIS&&(L().enqueue({text:"棋譜解析が終了しました。"}),this._appState=n.NORMAL)}showResearchDialog(){this._researchState===N.IDLE&&(this._researchState=N.STARTUP_DIALOG)}closeResearchDialog(){this._researchState===N.STARTUP_DIALOG&&(this._researchState=N.IDLE)}startResearch(e){if(!(this._researchState!==N.STARTUP_DIALOG||I().isBusy)){if(I().retain(),!e.usi){M().add(new Error("エンジンが設定されていません。"));return}p.saveResearchSettings(e).then(()=>this.researchManager.launch(e)).then(()=>{this._researchState=N.RUNNING,this.updateResearchPosition();const t=_();t.tab!==F.SEARCH&&t.tab!==F.PV&&t.tab!==F.CHART&&t.tab!==F.PERCENTAGE_CHART&&t.tab!==F.MONITOR&&_().updateAppSettings({tab:F.PV})}).catch(t=>{M().add("検討の初期化中にエラーが出ました: "+t)}).finally(()=>{I().release()})}}stopResearch(){this._researchState===N.RUNNING&&(this.researchManager.close(),this._researchState=N.IDLE)}isResearchEngineSessionID(e){return this.researchManager.isSessionExists(e)}onUpdateSearchInfo(e,t){this.recordManager.updateSearchInfo(e,t)}startAnalysis(e){this.appState!==n.ANALYSIS_DIALOG||I().isBusy||(I().retain(),p.saveAnalysisSettings(e).then(()=>this.analysisManager.start(e)).then(()=>{this._appState=n.ANALYSIS}).catch(t=>{M().add("検討の初期化中にエラーが出ました: "+t)}).finally(()=>{I().release()}))}stopAnalysis(){this.appState===n.ANALYSIS&&(this.analysisManager.close(),this._appState=n.NORMAL)}startMateSearch(e){if(!(this.appState!==n.MATE_SEARCH_DIALOG||I().isBusy)){if(I().retain(),!e.usi){M().add(new Error(h.engineNotSelected));return}p.saveMateSearchSettings(e).then(()=>this.mateSearchManager.start(e,this.recordManager.record)).then(()=>{this._appState=n.MATE_SEARCH;const t=_();t.tab!==F.SEARCH&&t.tab!==F.PV&&_().updateAppSettings({tab:F.SEARCH})}).catch(t=>{M().add(t)}).finally(()=>{I().release()})}}stopMateSearch(){this.appState===n.MATE_SEARCH&&(this.mateSearchManager.close(),this._appState=n.NORMAL)}onCheckmate(e){if(this.appState!==n.MATE_SEARCH)return;this._appState=n.NORMAL;const t=this.recordManager.record.position;this.showConfirmation({message:h.mateInNPlyDoYouWantToDisplay(e.length),onOk:()=>{this.showPVPreviewDialog({position:t,mate:e.length,pv:e})}})}onNotImplemented(){this.appState===n.MATE_SEARCH&&(M().add(new Error(h.thisEngineNotSupportsMateSearch)),this._appState=n.NORMAL)}onNoMate(){this.appState===n.MATE_SEARCH&&(L().enqueue({text:h.noMateFound}),this._appState=n.NORMAL)}onCheckmateError(e){this.appState===n.MATE_SEARCH&&(M().add(e),this._appState=n.NORMAL)}updateResearchPosition(){this.researchManager?.updatePosition(this.recordManager.record)}resetRecord(e="keepRootPosition"){this.appState==n.NORMAL&&this.showConfirmation({message:h.areYouSureWantToClearRecord,onOk:()=>{switch(e){case"keepRootPosition":this.recordManager.reset();break;case"hirateSetup":this.recordManager.resetByInitialPositionType(Xt.STANDARD);break}}})}updateRecordComment(e){this.recordManager.updateComment(e)}updateRecordBookmark(e){this.recordManager.updateBookmark(e)}insertSpecialMove(e){this.appState===n.NORMAL&&this.recordManager.appendMove({move:e})}startPositionEditing(){this.appState===n.NORMAL&&this.showConfirmation({message:h.areYouSureWantToClearRecord,onOk:()=>{this._appState=n.POSITION_EDITING,this.recordManager.resetByCurrentPosition()}})}endPositionEditing(){this.appState===n.POSITION_EDITING&&(this._appState=n.NORMAL)}initializePositionBySFEN(e){(this.appState===n.NORMAL||this.appState===n.POSITION_EDITING)&&this.showConfirmation({message:this.appState===n.NORMAL?h.areYouSureWantToClearRecord:h.areYouSureWantToDiscardPosition,onOk:()=>{this.recordManager.resetBySFEN(e)}})}changeTurn(){this.appState==n.POSITION_EDITING&&this.recordManager.swapNextTurn()}showPieceSetChangeDialog(){this.appState===n.POSITION_EDITING&&(this._appState=n.PIECE_SET_CHANGE_DIALOG)}closePieceSetChangeDialog(e){this.appState===n.PIECE_SET_CHANGE_DIALOG&&(e&&this.recordManager.changePieceSet(e),this._appState=n.POSITION_EDITING)}editPosition(e){this.appState===n.POSITION_EDITING&&this.recordManager.changePosition(e)}goForward(){(this.appState===n.NORMAL||this.appState===n.ELAPSED_TIME_CHART_DIALOG)&&this.recordManager.goForward()}goBack(){(this.appState===n.NORMAL||this.appState===n.ELAPSED_TIME_CHART_DIALOG)&&this.recordManager.goBack()}changePly(e){(this.appState===n.NORMAL||this.appState===n.ELAPSED_TIME_CHART_DIALOG)&&this.recordManager.changePly(e)}changeBranch(e){this.appState===n.NORMAL&&this.recordManager.changeBranch(e)}changeNode(e){this.appState===n.NORMAL&&this.recordManager.changeNode(e)}swapWithNextBranch(){return this.recordManager.swapWithNextBranch()}swapWithPreviousBranch(){return this.recordManager.swapWithPreviousBranch()}backToMainBranch(){this.appState===n.NORMAL&&this.recordManager.resetAllBranchSelection()}removeCurrentMove(){if(this.appState===n.NORMAL){if(this.recordManager.record.current.isLastMove){this.recordManager.removeCurrentMove();return}this.showConfirmation({message:h.areYouSureWantToDeleteFollowingMove(this.recordManager.record.current.ply),onOk:()=>{this.recordManager.removeCurrentMove()}})}}jumpToBookmark(e){return this.appState===n.NORMAL?this.recordManager.jumpToBookmark(e):!1}copyRecordKIF(e){const t=_(),i=e?.fromCurrentPosition?this.recordManager.record.getSubtree():this.recordManager.record,r=we(i,{returnCode:t.returnCode});navigator.clipboard.writeText(r)}copyRecordKI2(e){const t=_(),i=e?.fromCurrentPosition?this.recordManager.record.getSubtree():this.recordManager.record,r=Zt(i,{returnCode:t.returnCode});navigator.clipboard.writeText(r)}copyRecordCSA(e){const t=_(),i=e?.fromCurrentPosition?this.recordManager.record.getSubtree():this.recordManager.record,r=es(i,{returnCode:t.returnCode,v3:t.useCSAV3?{milliseconds:!0}:void 0});navigator.clipboard.writeText(r)}copyRecordUSI(e){const t=_(),r=(e==="after"?this.recordManager.record.getSubtree():this.recordManager.record).getUSI({startpos:t.enableUSIFileStartpos,resign:t.enableUSIFileSpecialMoves,repDraw:t.enableUSIFileSpecialMoves,draw:t.enableUSIFileSpecialMoves,timeout:t.enableUSIFileSpecialMoves,break:t.enableUSIFileSpecialMoves,win:t.enableUSIFileSpecialMoves,allMoves:e!=="before"});navigator.clipboard.writeText(r)}copyRecordJKF(e){const t=e?.fromCurrentPosition?this.recordManager.record.getSubtree():this.recordManager.record,i=ts(t);navigator.clipboard.writeText(i)}copyRecordUSEN(e){const t=e?.fromCurrentPosition?this.recordManager.record.getSubtree():this.recordManager.record,[i]=t.usen;navigator.clipboard.writeText(i)}copyBoardSFEN(){const e=this.recordManager.record.sfen;navigator.clipboard.writeText(e)}copyBoardBOD(){const e=ss(this.recordManager.record);navigator.clipboard.writeText(e)}pasteRecord(e,t="standard"){if(this.appState!==n.NORMAL)return;const i=this.recordManager.importRecord(e.trim(),{mode:t});if(i){M().add(i);return}}openRecord(e,t){if(this.appState!==n.NORMAL||I().isBusy){M().add(h.pleaseEndActiveFeaturesBeforeOpenRecord);return}I().retain(),Promise.resolve().then(()=>e||p.showOpenRecordDialog(is())).then(i=>{if(!i)return;const o=_().textDecodingRule==rs.AUTO_DETECT;return p.openRecord(i).then(a=>{const c=this.recordManager.importRecordFromBuffer(a,i,{autoDetect:o});return c&&Promise.reject(c)})}).then(()=>{t?.ply&&this.recordManager.changePly(t.ply)}).catch(i=>{M().add("棋譜の読み込み中にエラーが出ました: "+i)}).finally(()=>{I().release()})}saveRecord(e){this.appState!==n.NORMAL||I().isBusy||(I().retain(),Promise.resolve().then(()=>{const t=this.recordManager.recordFilePath;if(e?.overwrite&&t)return t;const i=_(),r=!e?.format&&t||xe(this.recordManager.record,{template:i.recordFileNameTemplate,extension:e?.format||i.defaultRecordFileFormat});return p.showSaveRecordDialog(r)}).then(t=>{if(t)return this.saveRecordByPath(t,{detectGarbled:!0}).then(()=>{const i=Ie(t),r=pi(this.recordManager.record,i),o=Object.entries(r).filter(([,a])=>a).map(([a])=>{switch(a){case"branch":return h.branches;case"comment":return h.comments;case"bookmark":return h.bookmark;case"time":return h.elapsedTime}}).map(a=>({text:a}));o.length&&L().enqueue({text:h.followingDataNotSavedBecauseNotSupporetedBy(i),attachments:[{type:"list",items:o}]})})}).catch(t=>{M().add(t)}).finally(()=>{I().release()}))}async saveRecordByPath(e,t){const i=_(),o=(t?.recordManager||this.recordManager).exportRecordAsBuffer(e,{returnCode:i.returnCode,detectGarbled:t?.detectGarbled,csa:{v3:i.useCSAV3},useUTF8ForKifAndKi2:i.useUTF8ForKifAndKi2});if(o instanceof Error)throw o;try{await p.saveRecord(e,o.data),o.garbled&&!this.garbledNotified&&(L().enqueue({text:`${h.recordSavedWithGarbledCharacters}
${h.pleaseConsiderToUseKIFU}
${h.youCanChangeDefaultRecordFileFormatFromAppSettings}`}),this.garbledNotified=!0)}catch(a){throw new Error(`${h.failedToSaveRecord}: ${a}`)}}restoreFromBackupV1(e){this.appState!==n.RECORD_FILE_HISTORY_DIALOG||I().isBusy||(I().retain(),p.loadRecordFileBackup(e).then(t=>{const i=this.recordManager.importRecord(t,{type:b.KIF,markAsSaved:!0});if(i)return Promise.reject(i);this._appState=n.NORMAL}).catch(t=>{M().add(t)}).finally(()=>{I().release()}))}restoreFromBackupV2(e){if(this.appState!==n.RECORD_FILE_HISTORY_DIALOG||I().isBusy)return;const t=this.recordManager.importRecord(e,{type:b.KIF,markAsSaved:!0});if(t){M().add(t);return}this._appState=n.NORMAL}get remoteRecordFileURL(){return this.recordManager.sourceURL}loadRemoteRecordFile(e){I().retain(),this.recordManager.importRecordFromRemoteURL(e).catch(t=>M().add(t)).finally(()=>I().release())}showJishogiPoints(){const e=this.recordManager.record.position,t=$e(e,S.BLACK),i=Ve(e,S.BLACK),r=X(J.GENERAL24,e,S.BLACK),o=X(J.GENERAL27,e,S.BLACK),a=$e(e,S.WHITE),c=Ve(e,S.WHITE),d=X(J.GENERAL24,e,S.WHITE),u=X(J.GENERAL27,e,S.WHITE);L().enqueue({text:h.jishogiPoints,attachments:[{type:"list",items:[{text:h.sente,children:[`Points (Total): ${t}`,`Points (Declaration): ${i}`,`Rule-24: ${r.toUpperCase()}`,`Rule-27: ${o.toUpperCase()}`]},{text:h.gote,children:[`Points (Total): ${a}`,`Points (Declaration): ${c}`,`Rule-24: ${d.toUpperCase()}`,`Rule-27: ${u.toUpperCase()}`]}]}],withCopyButton:!0})}get isMovableByUser(){switch(this.appState){case n.NORMAL:return!0;case n.GAME:return this.gameManager.waitingForHumanPlayerMove;case n.CSA_GAME:return this.csaGameManager.waitingForHumanPlayerMove}return!1}async onMainWindowClose(){I().retain();try{await this.recordManager.saveBackup()}finally{I().release()}}showConfirmation(e){const t=this.appState;Z().show({...e,onOk:()=>{if(this.appState!==t){M().add("確認ダイアログ表示中に他の操作が行われたため処理が中止されました。");return}e.onOk()}})}};function Ci(){return new Pi().reactive}let Re;function wi(){return Re||(Re=Ci()),Re}var dt=(s=>(s.SEND="send",s.RECEIVE="receive",s.SYSTEM="system",s))(dt||{});function bi(s,e){const t=new Date;return{type:s,command:e,dateTime:os(t),timeMs:t.getTime()}}function Oi(s,e,t,i){Array.isArray(e)||(e=[e]);for(const r of e)s.commands.push(r);if(s.commands.length>t){const r=Math.max(i,s.commands.length-t);s.discarded+=r,s.commands.splice(0,r)}}class Ai{_reactive;_target;_sessionID;_name;_history={discarded:0,commands:[]};_nextID=0;buffer=[];bufferTimer=null;constructor(){this._reactive=ke(this);const e=new URL(window.location.toString()).searchParams;this._target=e.get("target"),this._sessionID=Number(e.get("session")),this._name=e.get("name")||"unknown"}get reactive(){return this._reactive}get target(){return this._target}get sessionID(){return this._sessionID}get name(){return this._name}get history(){return this._history}async setup(){try{const e=await p.setupPrompt(this.target,this.sessionID);this._history={discarded:e.discarded,commands:e.commands.map(t=>({...t,id:this._nextID++}))}}catch(e){this.onError(e)}}onCommand(e){this.buffer.push({...e,id:this._nextID++}),!this.bufferTimer&&(this.bufferTimer=window.setTimeout(()=>{Oi(this._history,this.buffer,1e3,100),this.buffer=[],this.bufferTimer=null},250))}onError(e){this.onCommand(bi(dt.SYSTEM,`Failed to load command history: ${this.target}: ${this.sessionID}: ${e}`))}invokeCommand(e,t){p.invokePromptCommand(this.target,this.sessionID,e,t)}}function Ni(){return new Ai().reactive}let _e;function ki(){return _e||(_e=Ni()),_e}var l=(s=>(s.NEW_RECORD="newRecord",s.NEW_RECORD_HIRATE_SETUP="newRecordHirateSetup",s.OPEN_RECORD="openRecord",s.SAVE_RECORD="saveRecord",s.SAVE_RECORD_AS="saveRecordAs",s.HISTORY="history",s.LOAD_REMOTE_RECORD="loadRemoteRecord",s.BATCH_CONVERSION="batchConversion",s.SHARE="share",s.EXPORT_POSITION_IMAGE="exportPositionImage",s.COPY_RECORD="copyRecord",s.COPY_RECORD_KI2="copyRecordKi2",s.COPY_RECORD_CSA="copyRecordCsa",s.COPY_RECORD_USI_BEFORE="copyRecordUsiBefore",s.COPY_RECORD_USI_ALL="copyRecordUsiAll",s.COPY_RECORD_JKF="copyRecordJkf",s.COPY_RECORD_USEN="copyRecordUsen",s.COPY_RECORD_FROM_CURRENT_POSITION="copyRecordFromCurrentPosition",s.COPY_RECORD_KI2_FROM_CURRENT_POSITION="copyRecordKi2FromCurrentPosition",s.COPY_RECORD_CSA_FROM_CURRENT_POSITION="copyRecordCsaFromCurrentPosition",s.COPY_RECORD_USI_FROM_CURRENT_POSITION="copyRecordUsiFromCurrentPosition",s.COPY_RECORD_JKF_FROM_CURRENT_POSITION="copyRecordJkfFromCurrentPosition",s.COPY_RECORD_USEN_FROM_CURRENT_POSITION="copyRecordUsenFromCurrentPosition",s.COPY_BOARD_SFEN="copyRecordSfen",s.COPY_BOARD_BOD="copyRecordBod",s.PASTE_RECORD="pasteRecord",s.PASTE_RECORD_MERGE_INTO_ROOT_POSITION="pasteRecordMergeIntoRootPosition",s.PASTE_RECORD_MERGE_INTO_CURRENT_POSITION="pasteRecordMergeIntoCurrentPosition",s.SEARCH_DUPLICATE_POSITIONS="searchDuplicatePositions",s.INSERT_INTERRUPT="insertInterrupt",s.INSERT_RESIGN="insertResign",s.INSERT_DRAW="insertDraw",s.INSERT_IMPASS="insertImpass",s.INSERT_REPETITION_DRAW="insertRepetitionDraw",s.INSERT_MATE="insertMate",s.INSERT_NO_MATE="insertNoMate",s.INSERT_TIMEOUT="insertTimeout",s.INSERT_FOUL_WIN="insertFoulWin",s.INSERT_FOUL_LOSE="insertFoulLose",s.INSERT_ENTERING_OF_KING="insertEnteringOfKing",s.INSERT_WIN_BY_DEFAULT="insertWinByDefault",s.INSERT_LOSE_BY_DEFAULT="insertLossByDefault",s.REMOVE_CURRENT_MOVE="remvoeCurrentMove",s.START_POSITION_EDITING="startPositionEditing",s.END_POSITION_EDITING="endPositionEditing",s.CHANGE_TURN="changeTurn",s.INIT_POSITION="initPosition",s.CHANGE_PIECE_SET="changePieceSet",s.TOGGLE_RESEARCH="toggleResearch",s.START_ANALYSIS="startAnalysis",s.STOP_ANALYSIS="stopAnalysis",s.START_MATE_SEARCH="startMateSearch",s.STOP_MATE_SEARCH="stopMateSearch",s.START_GAME="startGame",s.START_CSA_GAME="startCSAGame",s.STOP_GAME="stopGame",s.RESIGN="resign",s.WIN="win",s.LOGOUT="logout",s.CALCULATE_POINTS="calculateJishogiPoints",s.DISPLAY_GAME_RESULTS="displayGameResults",s.FLIP_BOARD="flipBoard",s.APP_SETTINGS_DIALOG="appSettings",s.USI_ENGINES_DIALOG="usiEngines",s.LAUNCH_USI_ENGINE="launchUsiEngine",s.CONNECT_TO_CSA_SERVER="connectToCsaServer",s.ELAPSED_TIME_CHART="elapsedTimeChart",s))(l||{});function xi(){const s=wi(),e=_(),t=I();as(()=>[s.appState,s.researchState,t.isBusy],([i,r,o])=>T.updateAppState(i,r,o)),T.updateAppState(s.appState,s.researchState,t.isBusy),T.onClose(async i=>{try{for(const r of i)await new Promise((o,a)=>{Z().show({message:r,onOk:o,onCancel:a})})}catch{return}try{await s.onMainWindowClose()}catch(r){T.log(k.ERROR,`${r}`)}finally{T.onClosable()}}),T.onSendError(i=>{M().add(i)}),T.onSendMessage(i=>{L().enqueue(JSON.parse(i))}),T.onMenuEvent((i,...r)=>{if(!t.isBusy)switch(i){case l.NEW_RECORD:s.resetRecord();break;case l.NEW_RECORD_HIRATE_SETUP:s.resetRecord("hirateSetup");break;case l.OPEN_RECORD:s.openRecord();break;case l.SAVE_RECORD:s.saveRecord({overwrite:!0});break;case l.SAVE_RECORD_AS:s.saveRecord();break;case l.HISTORY:s.showRecordFileHistoryDialog();break;case l.LOAD_REMOTE_RECORD:s.showLoadRemoteFileDialog();break;case l.BATCH_CONVERSION:s.showBatchConversionDialog();break;case l.SHARE:s.showShareDialog();break;case l.EXPORT_POSITION_IMAGE:s.showExportBoardImageDialog();break;case l.COPY_RECORD:s.copyRecordKIF();break;case l.COPY_RECORD_KI2:s.copyRecordKI2();break;case l.COPY_RECORD_CSA:s.copyRecordCSA();break;case l.COPY_RECORD_USI_BEFORE:s.copyRecordUSI("before");break;case l.COPY_RECORD_USI_ALL:s.copyRecordUSI("all");break;case l.COPY_RECORD_JKF:s.copyRecordJKF();break;case l.COPY_RECORD_USEN:s.copyRecordUSEN();break;case l.COPY_RECORD_FROM_CURRENT_POSITION:s.copyRecordKIF({fromCurrentPosition:!0});break;case l.COPY_RECORD_KI2_FROM_CURRENT_POSITION:s.copyRecordKI2({fromCurrentPosition:!0});break;case l.COPY_RECORD_CSA_FROM_CURRENT_POSITION:s.copyRecordCSA({fromCurrentPosition:!0});break;case l.COPY_RECORD_USI_FROM_CURRENT_POSITION:s.copyRecordUSI("after");break;case l.COPY_RECORD_JKF_FROM_CURRENT_POSITION:s.copyRecordJKF({fromCurrentPosition:!0});break;case l.COPY_RECORD_USEN_FROM_CURRENT_POSITION:s.copyRecordUSEN({fromCurrentPosition:!0});break;case l.COPY_BOARD_SFEN:s.copyBoardSFEN();break;case l.COPY_BOARD_BOD:s.copyBoardBOD();break;case l.PASTE_RECORD:s.showPasteDialog();break;case l.PASTE_RECORD_MERGE_INTO_ROOT_POSITION:s.showPasteDialog("mergeIntoRoot");break;case l.PASTE_RECORD_MERGE_INTO_CURRENT_POSITION:s.showPasteDialog("mergeIntoCurrent");break;case l.SEARCH_DUPLICATE_POSITIONS:s.showSearchDuplicatePositionsDialog();break;case l.INSERT_INTERRUPT:s.insertSpecialMove(f.INTERRUPT);break;case l.INSERT_RESIGN:s.insertSpecialMove(f.RESIGN);break;case l.INSERT_DRAW:s.insertSpecialMove(f.DRAW);break;case l.INSERT_IMPASS:s.insertSpecialMove(f.IMPASS);break;case l.INSERT_REPETITION_DRAW:s.insertSpecialMove(f.REPETITION_DRAW);break;case l.INSERT_MATE:s.insertSpecialMove(f.MATE);break;case l.INSERT_NO_MATE:s.insertSpecialMove(f.NO_MATE);break;case l.INSERT_TIMEOUT:s.insertSpecialMove(f.TIMEOUT);break;case l.INSERT_FOUL_WIN:s.insertSpecialMove(f.FOUL_WIN);break;case l.INSERT_FOUL_LOSE:s.insertSpecialMove(f.FOUL_LOSE);break;case l.INSERT_ENTERING_OF_KING:s.insertSpecialMove(f.ENTERING_OF_KING);break;case l.INSERT_WIN_BY_DEFAULT:s.insertSpecialMove(f.WIN_BY_DEFAULT);break;case l.INSERT_LOSE_BY_DEFAULT:s.insertSpecialMove(f.LOSE_BY_DEFAULT);break;case l.REMOVE_CURRENT_MOVE:s.removeCurrentMove();break;case l.START_POSITION_EDITING:s.startPositionEditing();break;case l.END_POSITION_EDITING:s.endPositionEditing();break;case l.CHANGE_TURN:s.changeTurn();break;case l.INIT_POSITION:s.initializePositionBySFEN(r[0]);break;case l.CHANGE_PIECE_SET:s.showPieceSetChangeDialog();break;case l.START_MATE_SEARCH:s.showMateSearchDialog();break;case l.STOP_MATE_SEARCH:s.stopMateSearch();break;case l.START_GAME:s.showGameDialog();break;case l.START_CSA_GAME:s.showCSAGameDialog();break;case l.STOP_GAME:s.stopGame();break;case l.RESIGN:if(!s.isMovableByUser)break;Z().show({message:h.areYouSureWantToResign,onOk:()=>{Pe.resign()}});break;case l.WIN:if(!s.isMovableByUser)break;Z().show({message:h.areYouSureWantToDoDeclaration,onOk:()=>{Pe.win()}});break;case l.LOGOUT:s.cancelCSAGame();break;case l.CALCULATE_POINTS:s.showJishogiPoints();break;case l.DISPLAY_GAME_RESULTS:s.showGameResults();break;case l.TOGGLE_RESEARCH:s.researchState===N.RUNNING?s.stopResearch():s.showResearchDialog();break;case l.START_ANALYSIS:s.showAnalysisDialog();break;case l.STOP_ANALYSIS:s.stopAnalysis();break;case l.FLIP_BOARD:_().flipBoard();break;case l.APP_SETTINGS_DIALOG:s.showAppSettingsDialog();break;case l.USI_ENGINES_DIALOG:s.showUsiEngineManagementDialog();break;case l.LAUNCH_USI_ENGINE:s.showLaunchUSIEngineDialog();break;case l.CONNECT_TO_CSA_SERVER:s.showConnectToCSAServerDialog();break;case l.ELAPSED_TIME_CHART:s.showElapsedTimeChartDialog();break}}),T.onUpdateAppSettings(i=>{e.updateAppSettings(JSON.parse(i))}),T.onOpenRecord(i=>{Z().show({message:h.areYouSureWantToOpenFileInsteadOfCurrentRecord,onOk:()=>{s.openRecord(i)}})}),T.onUSIBestMove(vs),T.onUSICheckmate(Ds),T.onUSICheckmateNotImplemented(Ls),T.onUSICheckmateTimeout(Gs),T.onUSINoMate(Bs),T.onUSIInfo((i,r,o)=>{const a=JSON.parse(o);Us(i,r,a)}),T.onCSAGameSummary((i,r)=>{Zs(i,JSON.parse(r))}),T.onCSAReject(ei),T.onCSAStart((i,r)=>{ti(i,JSON.parse(r))}),T.onCSAMove((i,r,o)=>{si(i,r,JSON.parse(o))}),T.onCSAGameResult(ii),T.onCSAClose(ri),T.onUpdateLayoutProfile(i=>{s.updateLayoutProfile(i&&JSON.parse(i))}),T.onProgress(i=>{t.updateProgress(i)})}function Wi(){const s=ki();T.onPromptCommand(e=>{s.onCommand(JSON.parse(e))})}export{n as A,ct as C,N as R,C as S,ni as U,I as a,Ui as b,xi as c,ki as d,dt as e,Bi as f,Wi as g,Pe as h,Hi as i,js as l,Gi as o,qe as s,wi as u};
